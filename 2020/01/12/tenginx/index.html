<!DOCTYPE html>
<html  lang="zh">
<head>
    <meta charset="utf-8">
<title>Tengine 基础原理和基本使用 - qingye&#39;s blog</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />



    <meta name="description" content="1.Tengine简介2.Tengine特性3.Tengine工作原理和用途    - 3.1 Tengine处理HTTP请求流程    - 3.2 Tengine的模块化    - 3.3 Tengine进程模型    - 3.4 Tengine事件模型    - 3.5 Tengine信号    - 3.6 Tengine定时器4.Tengine安装部署    - 4.1 安装依赖    -">
<meta name="keywords" content="linux,nginx,tengine">
<meta property="og:type" content="article">
<meta property="og:title" content="Tengine 基础原理和基本使用">
<meta property="og:url" content="http:&#x2F;&#x2F;qingye.info&#x2F;2020&#x2F;01&#x2F;12&#x2F;tenginx&#x2F;index.html">
<meta property="og:site_name" content="qingye&#39;s blog">
<meta property="og:description" content="1.Tengine简介2.Tengine特性3.Tengine工作原理和用途    - 3.1 Tengine处理HTTP请求流程    - 3.2 Tengine的模块化    - 3.3 Tengine进程模型    - 3.4 Tengine事件模型    - 3.5 Tengine信号    - 3.6 Tengine定时器4.Tengine安装部署    - 4.1 安装依赖    -">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http:&#x2F;&#x2F;qingye.info&#x2F;images&#x2F;og_image.png">
<meta property="og:updated_time" content="2020-01-14T14:25:12.234Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http:&#x2F;&#x2F;qingye.info&#x2F;images&#x2F;og_image.png">





<link rel="alternative" href="/atom.xml" title="Tengine 基础原理和基本使用" type="application/atom+xml">



<link rel="icon" href="/images/favicon.ico">


<link rel="stylesheet" href="https://unpkg.com/bulma@0.7.2/css/bulma.css">
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.4.1/css/all.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Ubuntu:400,600|Source+Code+Pro">
<link rel="stylesheet" href="https://unpkg.com/highlight.js@9.12.0/styles/atom-one-dark.css">


    
    
    
    <style>body>.footer,body>.navbar,body>.section{opacity:0}</style>
    

    
    
    
    <link rel="stylesheet" href="https://unpkg.com/lightgallery@1.6.8/dist/css/lightgallery.min.css">
    <link rel="stylesheet" href="https://unpkg.com/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css">
    

    
    

<link rel="stylesheet" href="https://unpkg.com/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.css">


    
    
    
    

<link rel="stylesheet" href="/css/back-to-top.css">


    
    
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-118599694-1"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-118599694-1');
</script>


    
    
<script>
var _hmt = _hmt || [];
(function() {
    var hm = document.createElement("script");
    hm.src = "//hm.baidu.com/hm.js?f58a5db01159bcd69ce92836dd9bbbb2";
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(hm, s);
})();
</script>

    
    

    
    
<link rel="stylesheet" href="/css/progressbar.css">
<script src="https://unpkg.com/pace-js@1.0.2/pace.min.js"></script>

    
    
    

    
    
    
        <script async="" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    

    
    
    
        <script type="text/javascript" src="https://js.users.51.la/20079919.js"></script>
    

    
    
    
        <script>
            (function(){
                var bp = document.createElement('script');
                var curProtocol = window.location.protocol.split(':')[0];
                if (curProtocol === 'https'){
               bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
              }
              else{
              bp.src = 'http://push.zhanzhang.baidu.com/push.js';
              }
                var s = document.getElementsByTagName("script")[0];
                s.parentNode.insertBefore(bp, s);
            })();
            </script>
    

    
    
    
        <script>
            (function(){
            var src = (document.location.protocol == "http:") ? "http://js.passport.qihucdn.com/11.0.1.js?428f95ddc1f1e1d2fe658679fcd2092b":"https://jspassport.ssl.qhimg.com/11.0.1.js?428f95ddc1f1e1d2fe658679fcd2092b";
            document.write('<script src="' + src + '" id="sozz"><\/script>');
            })();
        </script>
    

    


<link rel="stylesheet" href="/css/style.css">
</head>
<body class="is-2-column">
    <nav class="navbar navbar-main">
    <div class="container">
        <div class="navbar-brand is-flex-center">
            <a class="navbar-item navbar-logo" href="/">
            
                <img src="/images/logo.svg" alt="Tengine 基础原理和基本使用" height="28">
            
            </a>
        </div>
        <div class="navbar-menu">
            
            <div class="navbar-start">
                
                <a class="navbar-item"
                href="/">首页</a>
                
                <a class="navbar-item"
                href="/archives/">归档</a>
                
                <a class="navbar-item"
                href="/categories">分类</a>
                
                <a class="navbar-item"
                href="/tags">标签</a>
                
                <a class="navbar-item"
                href="/about">关于</a>
                
            </div>
            
            <div class="navbar-end">
                
                    
                    
                    <a class="navbar-item" target="_blank" title="Download on GitHub" href="https://github.com/qingyeinfo">
                        
                        <i class="fab fa-github"></i>
                        
                    </a>
                    
                
                
                
                <a class="navbar-item search" title="搜索" href="javascript:;" target="_blank" rel="noopener">
                    <i class="fas fa-search"></i>
                </a>
                
            </div>
        </div>
    </div>
</nav>
    
    <section class="section">
        <div class="container">
            <div class="columns">
                <div class="column is-8-tablet is-9-desktop is-9-widescreen has-order-2 column-main"><div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2020-01-12T07:52:25.000Z">2020-01-12</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/Tengine/">Tengine</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    1 小时 读完 (大约 12590 个字)
                </span>
                
                
                <span class="level-item has-text-grey" id="busuanzi_container_page_pv">
                    <i class="far fa-eye"></i>
                    <span id="busuanzi_value_page_pv">0</span>次访问
                </span>
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                Tengine 基础原理和基本使用
            
        </h1>
        <div class="content">
            <p><a href="#1tengine简介"><em>1.Tengine简介</em></a><br><a href="#2tengine特性"><em>2.Tengine特性</em></a><br><a href="#3tengine工作原理和用途"><em>3.Tengine工作原理和用途</em></a><br>    - <a href="#31-tengine处理http请求流程"><em>3.1 Tengine处理HTTP请求流程</em></a><br>    - <a href="#32-tengine的模块化"><em>3.2 Tengine的模块化</em></a><br>    - <a href="#33-tengine进程模型"><em>3.3 Tengine进程模型</em></a><br>    - <a href="#34-tengine事件模型"><em>3.4 Tengine事件模型</em></a><br>    - <a href="#35-tengine信号"><em>3.5 Tengine信号</em></a><br>    - <a href="#36-tengine定时器"><em>3.6 Tengine定时器</em></a><br><a href="#4tengine安装部署"><em>4.Tengine安装部署</em></a><br>    - <a href="#41-安装依赖"><em>4.1 安装依赖</em></a><br>    - <a href="#42-编译"><em>4.2 编译</em></a><br><a href="#5tengine-文件目录结构"><em>5.Tengine 文件目录结构</em></a><br><a href="#6tengine-配置文件详解"><em>6.Tengine 配置文件详解</em></a><br>    - <a href="#61-tengine主配置文件"><em>6.1 tengine主配置文件</em></a><br>    - <a href="#62-状态检测配置文件"><em>6.2 状态检测配置文件</em></a><br>    - <a href="#63-tengine常用配置"><em>6.3 tengine常用配置</em></a><br><a href="#7tengine-安全防护"><em>7.Tengine 安全防护</em></a><br>    - <a href="#71-禁止web服务ip直接访问"><em>7.1 禁止web服务IP直接访问</em></a><br>    - <a href="#72-连接和请求数限制"><em>7.2 连接和请求数限制</em></a><br>    - <a href="#73-访问全站ip黑名单限制"><em>7.3 访问全站IP黑名单限制</em></a><br>    - <a href="#74-下载防盗链配置"><em>7.4 下载防盗链配置</em></a><br><a href="#8tengine-重要模块"><em>8.Tengine 重要模块</em></a><br>    - <a href="#81-upstream负载均衡模块"><em>8.1 upstream负载均衡模块</em></a><br>    - <a href="#82-rewrite重写模块"><em>8.2 rewrite重写模块</em></a><br><a href="#9location-在匹配中的优先级"><em>9.location 在匹配中的优先级</em></a><br><a href="#10tengine-root-和-alias-的区别"><em>10.Tengine root 和 alias 的区别</em></a><br><a href="#11tengine-tcp转发配置"><em>11.Tengine TCP转发配置</em></a><br><a href="#12tengine-常用维护脚本或命令"><em>12.Tengine 常用维护脚本或命令</em></a><br><a href="#13参考文档"><em>13.参考文档</em></a></p>
<h3 id="1-Tengine简介"><a href="#1-Tengine简介" class="headerlink" title="1.Tengine简介"></a><em>1.Tengine简介</em></h3><p><em>Tengine是由淘宝网发起的Web服务器项目。它在Nginx的基础上，针对大访问量网站的需求，添加了很多高级功能和特性。Tengine的性能和稳定性已经在大型的网站如淘宝网，天猫商城等得到了很好的检验。它的最终目标是打造一个高效、稳定、安全、易用的Web平台。从2011年12月开始，Tengine成为一个开源项目，Tengine团队在积极地开发和维护着它。Tengine团队的核心成员来自于淘宝、搜狗等互联网企业。Tengine是社区合作的成果，我们欢迎大家参与其中，贡献自己的力量。</em></p>
<h3 id="2-Tengine特性"><a href="#2-Tengine特性" class="headerlink" title="2.Tengine特性"></a><em>2.Tengine特性</em></h3><a id="more"></a>
<ul>
<li><p>继承Nginx-1.8.1的所有特性，兼容Nginx的配置</p>
</li>
<li><p>动态模块加载（DSO）支持。加入一个模块不再需要重新编译整个Tengine</p>
</li>
<li><p>支持HTTP/2协议，HTTP/2模块替代SPDY模块</p>
</li>
<li><p>流式上传到HTTP后端服务器或FastCGI服务器，大量减少机器的I/O压力</p>
</li>
<li><p>更加强大的负载均衡能力，包括一致性hash模块、会话保持模块，还可以对后端的服务器进行主动健康检查，根据服务器状态自动上线下线，以及动态解析upstream中出现的域名</p>
</li>
<li><p>输入过滤器机制支持，通过使用这种机制Web应用防火墙的编写更为方便</p>
</li>
<li><p>支持设置proxy、memcached、fastcgi、scgi、uwsgi在后端失败时的重试次数</p>
</li>
<li><p>动态脚本语言Lua支持。扩展功能非常高效简单</p>
</li>
<li><p>支持按指定关键字(域名，url等)收集Tengine运行状态</p>
</li>
<li><p>组合多个CSS、JavaScript文件的访问请求变成一个请求</p>
</li>
<li><p>自动去除空白字符和注释从而减小页面的体积</p>
</li>
<li><p>自动根据CPU数目设置进程个数和绑定CPU亲缘性</p>
</li>
<li><p>监控系统的负载和资源占用从而对系统进行保护</p>
</li>
<li><p>显示对运维人员更友好的出错信息，便于定位出错机器</p>
</li>
<li><p>更强大的防攻击（访问速度限制）模块</p>
</li>
<li><p>更方便的命令行参数，如列出编译的模块列表、支持的指令等</p>
</li>
<li><p>可以根据访问文件类型设置过期时间</p>
</li>
</ul>
<h3 id="3-Tengine工作原理和用途"><a href="#3-Tengine工作原理和用途" class="headerlink" title="3.Tengine工作原理和用途"></a><em>3.Tengine工作原理和用途</em></h3><h4 id="3-1-Tengine处理HTTP请求流程"><a href="#3-1-Tengine处理HTTP请求流程" class="headerlink" title="3.1 Tengine处理HTTP请求流程"></a><em>3.1 Tengine处理HTTP请求流程</em></h4><p>http请求是典型的请求-响应类型的的网络协议。http是文件协议，所以我们在分析请求行与请求头，以及输出响应行与响应头，往往是一行一行的进行处理。通常在一个连接建立好后，读取一行数据，分析出请求行中包含的method、uri、http_version信息。然后再一行一行处理请求头，并根据请求method与请求头的信息来决定是否有请求体以及请求体的长度，然后再去读取请求体。得到请求后，我们处理请求产生需要输出的数据，然后再生成响应行，响应头以及响应体。在将响应发送给客户端之后，一个完整的请求就处理完了。处理流程图：</p>
<p><img src="https://cloud.qingye.info/images/20200112/nginx-1.png" alt></p>
<p><img src="https://cloud.qingye.info/images/20200112/nginx-2.png" alt="tengine-请求流程"></p>
<h4 id="3-2-Tengine的模块化"><a href="#3-2-Tengine的模块化" class="headerlink" title="3.2 Tengine的模块化"></a><em>3.2 Tengine的模块化</em></h4><p>Nginx由内核和模块组成。Nginx的模块从结构上分为核心模块、基础模块和第三方模块：</p>
<ul>
<li><p>核心模块：HTTP模块、EVENT模块和MAIL模块</p>
</li>
<li><p>基础模块：HTTP Access模块、HTTP FastCGI模块、HTTP Proxy模块和HTTP Rewrite模块，</p>
</li>
<li><p>第三方模块：HTTP Upstream Request Hash模块、Notice模块和HTTP Access Key模块。<br>用户根据自己的需要开发的模块都属于第三方模块。正是有了这么多模块的支撑，Nginx的功能才会如此强大，Nginx的模块从功能上分为如下三类。</p>
</li>
<li><p>Handlers（处理器模块）：此类模块直接处理请求，并进行输出内容和修改headers信息等操作。Handlers处理器模块一般只能有一个。</p>
</li>
<li><p>Filters （过滤器模块）：此类模块主要对其他处理器模块输出的内容进行修改操作，最后由Nginx输出。</p>
</li>
<li><p>Proxies （代理类模块）：此类模块是Nginx的HTTP Upstream之类的模块，这些模块主要与后端一些服务比如FastCGI等进行交互，实现服务代理和负载均衡等功能。<br>Nginx模块常规的HTTP请求和响应的过程：<br><img src="https://cloud.qingye.info/images/20200112/nginx-3.png" alt="tengine-模块"><br>Nginx本身做的工作实际很少，当它接到一个HTTP请求时，它仅仅是通过查找配置文件将此次请求映射到一个location block，而此location中所配置的各个指令则会启动不同的模块去完成工作，因此模块可以看做Nginx真正的劳动工作者。通常一个location中的指令会涉及一个handler模块和多个filter模块（当然，多个location可以复用同一个模块）。handler模块负责处理请求，完成响应内容的生成，而filter模块对响应内容进行处理。</p>
</li>
</ul>
<h4 id="3-3-Tengine进程模型"><a href="#3-3-Tengine进程模型" class="headerlink" title="3.3 Tengine进程模型"></a><em>3.3 Tengine进程模型</em></h4><p>Nginx默认采用多进程工作方式，Nginx启动后，会运行一个master进程和多个worker进程。其中master充当整个进程组与用户的交互接口，同时对进程进行监护，管理worker进程来实现重启服务、平滑升级、更换日志文件、配置文件实时生效等功能。worker用来处理基本的网络事件，worker之间是平等的，他们共同竞争来处理来自客户端的请求。<br>nginx的进程模型如图所示：</p>
<p><img src="https://cloud.qingye.info/images/20200112/nginx-4.png" alt="tengine-进程模型"></p>
<p>请求到来时，如何分配均分worker进程来处理他们？</p>
<p>在创建master进程时，先建立需要监听的socket（listenfd），然后从master进程中fork()出多个worker进程，如此一来每个worker进程多可以监听用户请求的socket。一般来说，当一个连接进来后，所有在Worker都会收到通知，但是只有一个进程可以接受这个连接请求，其它的都失败，这是所谓的惊群现象。nginx提供了一个accept_mutex（互斥锁），有了这把锁之后，同一时刻，就只会有一个进程在accpet连接，这样就不会有惊群问题了。</p>
<p>先打开accept_mutex选项，只有获得了accept_mutex的进程才会去添加accept事件。nginx使用一个叫ngx_accept_disabled的变量来控制是否去竞争accept_mutex锁。ngx_accept_disabled = nginx单进程的所有连接总数 / 8 -空闲连接数量，当ngx_accept_disabled大于0时，不会去尝试获取accept_mutex锁，ngx_accept_disable越大，于是让出的机会就越多，这样其它进程获取锁的机会也就越大。不去accept，每个worker进程的连接数就控制下来了，其它进程的连接池就会得到利用，这样，nginx就控制了多进程间连接的平衡。</p>
<p>每个worker进程都有一个独立的连接池，连接池的大小是worker_connections。这里的连接池里面保存的其实不是真实的连接，它只是一个worker_connections大小的一个ngx_connection_t结构的数组。并且，nginx会通过一个链表free_connections来保存所有的空闲ngx_connection_t，每次获取一个连接时，就从空闲连接链表中获取一个，用完后，再放回空闲连接链表里面。一个nginx能建立的最大连接数，应该是worker_connections 乘以 worker_processes。当然，这里说的是最大连接数，对于HTTP请求本地资源来说，能够支持的最大并发数量是worker_connections 乘以 worker_processes，而如果是HTTP作为反向代理来说，最大并发数量应该是worker_connections 乘以 worker_processes/2。因为作为反向代理服务器，每个并发会建立与客户端的连接和与后端服务的连接，会占用两个连接。</p>
<h4 id="3-4-Tengine事件模型"><a href="#3-4-Tengine事件模型" class="headerlink" title="3.4 Tengine事件模型"></a><em>3.4 Tengine事件模型</em></h4><p>对于一个基本的web服务器来说，事件通常有三种类型，网络事件、信号的处理。Nginx每个worker里面只有一个主线程，多少个worker就能处理多少个并发，何来高并发呢？请求流程：首先，请求到来，要建立连接，然后再接收数据，接收数据后，再发送数据。具体到系统底层，就是读写事件，而当读写事件没有准备好时，不可操作。apache的常用工作方式：每个请求会独占一个工作线程，当并发数上到几千时，就同时有几千的线程在处理请求了。这对操作系统来说，是个不小的挑战，线程带来的内存占用非常大，线程的上下文切换带来的cpu开销很大，自然性能就上不去了，而这些开销完全是没有意义的。</p>
<p>Nginx采用异步非阻塞的方式来支持用户请求。Nginx支持select/poll/epoll/kqueue等事件模型。拿epoll为例，当事件没准备好时，放到epoll里面，事件准备好了，我们就去读写，当读写返回EAGAIN时，我们将它再次加入到epoll里面。这样，只要有事件准备好了，我们就去处理它，当事件都没有完全准备好时，就在epoll里面等着。这样，我们就可以并发处理大量的并发了，当然，这里的并发请求，是指未处理完的请求，线程只有一个，所以同时能处理的请求当然只有一个了，只是在请求间进行不断地切换而已，切换也是因为异步事件未准备好，而主动让出的。这里的切换是没有任何代价，你可以理解为循环处理多个准备好的事件，事实上就是这样的。与多线程相比，这种事件处理方式是有很大的优势的，不需要创建线程，每个请求占用的内存也很少，没有上下文切换，事件处理非常的轻量级。并发数再多也不会导致无谓的资源浪费（上下文切换），更多的并发数，只是会占用更多的内存而已。 现在的网络服务器基本都采用这种方式，这也是nginx性能高效的主要原因。</p>
<p>推荐设置worker的个数为cpu的核数，因为更多的worker数，只会导致进程来竞争cpu资源了，从而带来不必要的上下文切换。而且，nginx为了更好的利用多核特性，提供了cpu亲缘性的绑定选项，我们可以将某一个进程绑定在某一个核上，这样就不会因为进程的切换带来cache的失效。</p>
<h4 id="3-5-Tengine信号"><a href="#3-5-Tengine信号" class="headerlink" title="3.5 Tengine信号"></a><em>3.5 Tengine信号</em></h4><p><em>对nginx来说，有一些特定的信号，代表着特定的意义。信号会中断掉程序当前的运行，在改变状态后，继续执行。如果是系统调用，则可能会导致系统调用的失败，需要重新进行一次。如果nginx正在等待事件（epoll_wait时），如果程序收到信号，在信号处理函数处理完后，epoll_wait会返回错误，然后程序可再次进入epoll_wait调用。</em></p>
<h4 id="3-6-Tengine定时器"><a href="#3-6-Tengine定时器" class="headerlink" title="3.6 Tengine定时器"></a><em>3.6 Tengine定时器</em></h4><p>由于epoll_wait等函数在调用的时候是可以设置一个超时时间的，所以nginx借助这个超时时间来实现定时器。nginx里面的定时器事件是放在一颗维护定时器的红黑树里面，每次在进入epoll_wait前，先从该红黑树里面拿到所有定时器事件的最小时间，在计算出epoll_wait的超时时间后进入epoll_wait。所以，当没有事件产生，也没有中断信号时，epoll_wait会超时，也就是说，定时器事件到了。这时，nginx会检查所有的超时事件，将他们的状态设置为超时，然后再去处理网络事件。由此可以看出，当我们写nginx代码时，在处理网络事件的回调函数时，通常做的第一个事情就是判断超时，然后再去处理网络事件</p>
<h3 id="4-Tengine安装部署"><a href="#4-Tengine安装部署" class="headerlink" title="4.Tengine安装部署"></a><em>4.Tengine安装部署</em></h3><h4 id="4-1-安装依赖"><a href="#4-1-安装依赖" class="headerlink" title="4.1 安装依赖"></a><em>4.1 安装依赖</em></h4><figure class="highlight bash hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install zlib zlib-devel openssl openssl-devel pcre pcre-devel   gcc gcc-c++ autoconf automake jemalloc jemalloc-devel</span><br></pre></td></tr></table></figure>

<h4 id="4-2-编译"><a href="#4-2-编译" class="headerlink" title="4.2 编译"></a><em>4.2 编译</em></h4><figure class="highlight bash hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf tengine-2.2.0.tar.gz</span><br><span class="line"><span class="hljs-built_in">cd</span> tengine-2.2.0</span><br><span class="line">./configure  --with-http_stub_status_module --with-http_ssl_module --with-http_gzip_static_module  --with-http_concat_module --with-jemalloc --with-http_v2_module --with-http_secure_link_module</span><br><span class="line">make &amp;&amp; make install</span><br><span class="line"><span class="hljs-comment">#编译选项解析</span></span><br><span class="line">./configure  --with-http_stub_status_module  <span class="hljs-comment">#添加监控状态配置</span></span><br><span class="line">             --with-http_ssl_module          <span class="hljs-comment">#支持https</span></span><br><span class="line">             --with-http_gzip_static_module  <span class="hljs-comment">#支持静态文件预压缩</span></span><br><span class="line">             --with-http_concat_module       <span class="hljs-comment">#用于合并多个文件在一个响应报文中</span></span><br><span class="line">             --with-jemalloc                 <span class="hljs-comment">#支持jemalloc内存管理</span></span><br><span class="line">             --with-http_v2_module           <span class="hljs-comment">#支持http_v2</span></span><br><span class="line">             --with-http_secure_link_module  <span class="hljs-comment">#防下载盗链支持</span></span><br></pre></td></tr></table></figure>

<h3 id="5-Tengine-文件目录结构"><a href="#5-Tengine-文件目录结构" class="headerlink" title="5.Tengine 文件目录结构"></a><em>5.Tengine 文件目录结构</em></h3><p><img src="https://cloud.qingye.info/images/20200112/nginx-5.png" alt="tengine-目录结构"></p>
<figure class="highlight bash hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">|---certs ：存放域名证书位置，自建的规范目录</span><br><span class="line">|---client_body_temp：如果客户端POST一个比较大的文件，长度超过了nginx缓冲区的大小，需要把这个文件的部分或者全部内容暂存到client_body_temp目录下的临时文件</span><br><span class="line">|---conf：主配置文件存放目录</span><br><span class="line">|---conf.d：存放虚拟主机的配置文件，自建规范目录</span><br><span class="line">|---fastcgi_temp：对于来自 FastCGI Server 的 Response，Nginx 将其缓冲到内存中，然后依次发送到客户端浏览器。缓冲区的大小由 fastcgi_buffers 和 fastcgi_buffer_size 两个值控制，fastcgi_buffers 控制 nginx 最多创建 8 个大小为 4K 的缓冲区，而 fastcgi_buffer_size 则是处理 Response 时第一个缓冲区的大小，不包含在前者中，超出部分存在这个目录</span><br><span class="line">|---html：静态文件默认存放位置</span><br><span class="line">|---include：存放编译代码头文件目录</span><br><span class="line">|---logs：默认存放日志目录</span><br><span class="line">|---modules:存放模块目录</span><br><span class="line">|---proxy_temp:后端返回数据的临时存放目录</span><br><span class="line">|---sbin:nginx二进制文件存放目录</span><br><span class="line">|---scgi_temp:客户端可能会向服务器端请求大量的数据,服务器端收到的请求报文中的body中可能会有很多的数据,而这些数据都会存放内存中,倘若有很多的用户并发发出请求,服务器端内存无法存放，因此就会把数据临时存放在磁盘上的这些临时文件内</span><br><span class="line">|---uwsgi_temp:代理服务器时缓存文件的存放路径</span><br></pre></td></tr></table></figure>

<h3 id="6-Tengine-配置文件详解"><a href="#6-Tengine-配置文件详解" class="headerlink" title="6.Tengine 配置文件详解"></a><em>6.Tengine 配置文件详解</em></h3><h4 id="6-1-tengine主配置文件"><a href="#6-1-tengine主配置文件" class="headerlink" title="6.1 tengine主配置文件"></a><em>6.1 tengine主配置文件</em></h4><figure class="highlight bash hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">#/usr/local/nginx/conf/nginx.conf</span></span><br><span class="line">user nobody nobody;          <span class="hljs-comment"># 指定运行的用户和用户组</span></span><br><span class="line">    worker_processes  auto;      <span class="hljs-comment"># 指定要开启的进程数，一般为CPU的核心数或两倍</span></span><br><span class="line">    worker_cpu_affinity auto;    <span class="hljs-comment"># cpu亲和性</span></span><br><span class="line">    worker_rlimit_nofile 102400; <span class="hljs-comment"># 这个指令是指当一个nginx进程打开的最多文件描述符数目，理论值应该是最多打开文件数(ulimit -n)与nginx进程数相除，但是nginx 分配请求并不是那么均匀，所以最好与ulimit -n 的值保持一致</span></span><br><span class="line">    pid        logs/nginx.pid;   <span class="hljs-comment">#进程号存放位置</span></span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    use epoll;                 <span class="hljs-comment"># 指定nginx的工作模式</span></span><br><span class="line">    worker_connections  65535; <span class="hljs-comment"># 定义每个进程的最大连接数</span></span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    req_status_zone server <span class="hljs-string">"<span class="hljs-variable">$server_addr</span>:<span class="hljs-variable">$server_port</span>"</span> 10M; <span class="hljs-comment"># 根据变量值分别统计Tengine的运行状况</span></span><br><span class="line">    include           mime.types;                           <span class="hljs-comment"># 服务器识别的文件类型</span></span><br><span class="line">    default_type      application/octet-stream;             <span class="hljs-comment"># 文件类型未定义时默认识别为二进制流</span></span><br><span class="line">    check_shm_size 20M;    <span class="hljs-comment">#后端检测内存区大小</span></span><br><span class="line">    sendfile          on;  <span class="hljs-comment"># 高速传输文件</span></span><br><span class="line">    tcp_nopush        on;  <span class="hljs-comment"># 防止网络阻塞</span></span><br><span class="line">    tcp_nodelay       on; <span class="hljs-comment"># 防止网络阻塞</span></span><br><span class="line">    server_tokens     off; <span class="hljs-comment"># 不返回nginx的版本信息</span></span><br><span class="line">    server_info off;       <span class="hljs-comment">#返回错误页面是不返回服务器信息</span></span><br><span class="line">    keepalive_timeout 20s;    <span class="hljs-comment"># 一个keepalive 连接被闲置以后还能保持多久打开状态</span></span><br><span class="line">    keepalive_requests 1000;  <span class="hljs-comment"># 这是一个客户端可以通过一个keepalive连接的请求次数。缺省值是100，但是也可以调得很高，而且这对于测试负载生成工具从哪里使用一个客户端发送这么多请求非常有用</span></span><br><span class="line"></span><br><span class="line">    gzip              on;     <span class="hljs-comment"># 开启gzip压缩输出</span></span><br><span class="line">    gzip_min_length   1024;   <span class="hljs-comment"># 最小压缩文件大小</span></span><br><span class="line">    gzip_buffers      16 8k;  <span class="hljs-comment"># 压缩缓冲区</span></span><br><span class="line">    gzip_comp_level   6;      <span class="hljs-comment"># 压缩等级</span></span><br><span class="line">    gzip_proxied      any;    <span class="hljs-comment"># Nginx作为反向代理的时候启用,根据某些请求和应答来决定是否在对代理请求的应答启用gzip压缩，是否压缩取决于请求头中的“Via”字段启用压缩,这里是如果header头中包含 "Expires" 头信息</span></span><br><span class="line">    gzip_types        text/plain text/css application/x-javascript text/xml application/xml application/xml+rss text/javascript application/javascript; <span class="hljs-comment">#压缩类型，默认就已经包含text/html，所以下面就不用再写了</span></span><br><span class="line">                              <span class="hljs-comment"># 写上去也不会有问题，但是会有一个warn</span></span><br><span class="line">    gzip_vary  on;            <span class="hljs-comment"># 让前端的缓存服务器缓存经过gzip压缩的页面，和http头有关系，加个vary头，给代理服务器用的，有的浏览器支持压缩，有的不支持，所以避免浪费不支持的也压缩，所以根据客户端的HTTP头来判断，是否需要压缩</span></span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">    fastcgi_intercept_errors    on;    <span class="hljs-comment"># 这个指令指定是否传递4xx和5xx错误信息到客户端，或者允许nginx使用error_page处理错误信息</span></span><br><span class="line">    fastcgi_connect_timeout     75s;   <span class="hljs-comment"># 指定连接到后端FastCGI的超时时间</span></span><br><span class="line">    fastcgi_send_timeout        300s;  <span class="hljs-comment"># 指定向FastCGI传送请求的超时时间，这个值是已经完成两次握手后向FastCGI传送请求的超时时间。</span></span><br><span class="line">    fastcgi_read_timeout        300s;  <span class="hljs-comment"># 指定接收FastCGI应答的超时时间，这个值是已经完成两次握手后接收FastCGI应答的超时时间。</span></span><br><span class="line">    fastcgi_buffer_size         16k;   <span class="hljs-comment"># 用于指定读取FastCGI应答第一部分需要用多大的缓冲区，这个值表示将使用1个64KB的缓冲区读取应答的第一部分（应答头），可以设置为fastcgi_buffers选项指定的缓冲区大小</span></span><br><span class="line">    fastcgi_buffers             4 16k; <span class="hljs-comment"># 指定本地需要用多少和多大的缓冲区来缓冲FastCGI的应答请求。如果一个PHP脚本所产生的页面大小为256KB,那么会为其分配4个64KB的缓冲区来缓存,如果页面大小大于256KB，那么大于256K</span></span><br><span class="line">                                        <span class="hljs-comment"># B的部分会缓存到</span></span><br><span class="line">    fastcgi_busy_buffers_size   32k;   <span class="hljs-comment"># 繁忙模式下的缓冲区大小，默认值是fastcgi_buffers的两倍</span></span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">#open_file_cache max=10240 inactive=20s; # 最多缓存多少个文件，缓存多少时间</span></span><br><span class="line">    <span class="hljs-comment">#open_file_cache_valid 30s;              # 多少时间检查一次，如果发现20s内没有用过一次的删除</span></span><br><span class="line">    <span class="hljs-comment">#open_file_cache_min_uses 1;             # 在20S中没有使用到这个配置的次数的话就删除</span></span><br><span class="line"></span><br><span class="line">    client_body_timeout         90s;        <span class="hljs-comment"># 设置客户端请求头读取超时的时间</span></span><br><span class="line">    client_max_body_size        20m;        <span class="hljs-comment"># 用来设置允许客户端请求的最大的单个文件字节数</span></span><br><span class="line">    client_body_buffer_size     1m;         <span class="hljs-comment"># 设置缓存区的最大值</span></span><br><span class="line">    client_header_buffer_size   128k;       <span class="hljs-comment"># 用于指定来自客户端请求头的header buffer大小</span></span><br><span class="line">    large_client_header_buffers 256 16k;    <span class="hljs-comment"># 用来指定客户端请求中较大的消息头和缓存最大数量和大小</span></span><br><span class="line"></span><br><span class="line">    proxy_buffer_size 16k;                  <span class="hljs-comment"># 设置代理服务器（nginx）保存用户头信息的缓冲区大小</span></span><br><span class="line">    proxy_buffers 8 32k;                    <span class="hljs-comment"># proxy_buffers缓冲区，网页平均在32k以下的设置</span></span><br><span class="line">    proxy_busy_buffers_size 64k;            <span class="hljs-comment"># 高负荷下缓冲大小（proxy_buffers*2）</span></span><br><span class="line">    proxy_connect_timeout 300s;             <span class="hljs-comment"># nginx跟后端服务器连接超时时间(代理连接超时)</span></span><br><span class="line">    proxy_send_timeout 300s;                <span class="hljs-comment"># 后端服务器数据回传时间(代理发送超时)</span></span><br><span class="line">    proxy_read_timeout 300s;                <span class="hljs-comment"># 连接成功后，后端服务器响应时间(代理接收超时)</span></span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">#proxy_temp_path   /usr/local/nginx/proxy_temp; # 缓存临时目录。后端的响应并不直接返回客户端，而是先写到一个临时文件中，然后被rename一下当做缓存放在 proxy_cache_path</span></span><br><span class="line">    <span class="hljs-comment">#proxy_cache_path ... ： 设置缓存目录，目录里的文件名是 cache_key 的MD5值。</span></span><br><span class="line">    <span class="hljs-comment">#levels=1:2 keys_zone=cache_one:50m表示采用2级目录结构，Web缓存区名称为cache_one，内存缓存空间大小为100MB，这个缓冲zone可以被多次使用。文件系统上看到的缓存文件名类似于 /usr/local/nginx-1.6/proxy_cache/c/29/b7f54b2df7773722d382f4809d65029c inactive=2d max_size=2g表示2天没有被访问的内容自动清除，硬盘最大缓存空间为2GB，超过这个大学将清除最近最少使用的数据。</span></span><br><span class="line">    <span class="hljs-comment">#proxy_cache_path /usr/local/nginx/proxy_cache levels=1:2 keys_zone=cache_one:100m inactive=2d max_size=2g;这两句需要搭配location里面的指令使用，默认不开启</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    map <span class="hljs-variable">$upstream_addr</span> <span class="hljs-variable">$short_address</span> &#123;</span><br><span class="line">        ~^\d+\.\d+\.(.*) <span class="hljs-string">''</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    add_header X-from <span class="hljs-variable">$short_address</span><span class="hljs-variable">$1</span>;</span><br><span class="line"></span><br><span class="line">    proxy_set_header Host <span class="hljs-variable">$host</span>;</span><br><span class="line">    proxy_set_header X-User-IP  <span class="hljs-variable">$clientRealIp</span>;</span><br><span class="line">    proxy_set_header X-Real-IP  <span class="hljs-variable">$remote_addr</span>;</span><br><span class="line">    proxy_set_header X-Forwarded-For <span class="hljs-variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">    proxy_pass_header User-Agent;</span><br><span class="line">    proxy_set_header  X-Forwarded-Proto <span class="hljs-variable">$scheme</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">     map <span class="hljs-variable">$http_x_forwarded_for</span>  <span class="hljs-variable">$clientRealIp</span> &#123;</span><br><span class="line">       <span class="hljs-string">""</span>      <span class="hljs-variable">$remote_addr</span>;</span><br><span class="line">       ~^(?P&lt;firstAddr&gt;[0-9\.]+),?.*$  <span class="hljs-variable">$firstAddr</span>;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     log_format main  <span class="hljs-string">'&#123; "@timestamp": "$time_iso8601", '</span></span><br><span class="line">                         <span class="hljs-string">'"remote_addr": "$remote_addr", '</span></span><br><span class="line">                         <span class="hljs-string">'"upstream_addr": "$upstream_addr", '</span></span><br><span class="line">                         <span class="hljs-string">'"server_addr": "$server_addr", '</span></span><br><span class="line">                         <span class="hljs-string">'"http_host": "$http_host",'</span></span><br><span class="line">                         <span class="hljs-string">'"request_time": $request_time, '</span></span><br><span class="line">                         <span class="hljs-string">'"upstream_response_time": $upstream_response_time, '</span></span><br><span class="line">                         <span class="hljs-string">'"request_uri": "$request_uri", '</span></span><br><span class="line">                         <span class="hljs-string">'"status": "$status", '</span></span><br><span class="line">                         <span class="hljs-string">'"request": "$request", '</span></span><br><span class="line">                         <span class="hljs-string">'"request_method": "$request_method", '</span></span><br><span class="line">                         <span class="hljs-string">'"http_referer": "$http_referer", '</span></span><br><span class="line">                         <span class="hljs-string">'"body_bytes_sent": $body_bytes_sent, '</span></span><br><span class="line">                         <span class="hljs-string">'"http_x_forwarded_for": "$http_x_forwarded_for", '</span></span><br><span class="line">                         <span class="hljs-string">'"request_length": $request_length, '</span></span><br><span class="line">                         <span class="hljs-string">'"http_user_agent": "$http_user_agent", '</span></span><br><span class="line">                         <span class="hljs-string">'"scheme": "$scheme",'</span></span><br><span class="line">                         <span class="hljs-string">'"uri": "$uri",'</span></span><br><span class="line">                         <span class="hljs-string">'"clientRealIp": "$clientRealIp"&#125;'</span>;</span><br><span class="line"></span><br><span class="line">    include /usr/<span class="hljs-built_in">local</span>/nginx/conf.d/*.conf;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="6-2-状态检测配置文件"><a href="#6-2-状态检测配置文件" class="headerlink" title="6.2 状态检测配置文件"></a><em>6.2 状态检测配置文件</em></h4><figure class="highlight bash hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">#/usr/local/nginx/conf.d/admin.conf</span></span><br><span class="line">server &#123;</span><br><span class="line">    listen 8000;</span><br><span class="line">        location ~ ^/(phpfpm_status|ping)$ &#123;</span><br><span class="line">                fastcgi_pass   127.0.0.1:9000;</span><br><span class="line">                include fastcgi.conf;</span><br><span class="line">        &#125;</span><br><span class="line">    location = /nginx_status &#123;</span><br><span class="line">        stub_status on;</span><br><span class="line">        access_log off;</span><br><span class="line">    &#125;</span><br><span class="line">    location = /nginx_status_detail &#123;</span><br><span class="line">        req_status_show;</span><br><span class="line">    &#125;</span><br><span class="line">    location = /nstatus &#123;</span><br><span class="line">         check_status;</span><br><span class="line">         access_log off;</span><br><span class="line">         <span class="hljs-comment">#allow IP;</span></span><br><span class="line">         <span class="hljs-comment">#deny all;</span></span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="6-3-tengine常用配置"><a href="#6-3-tengine常用配置" class="headerlink" title="6.3 tengine常用配置"></a><em>6.3 tengine常用配置</em></h4><figure class="highlight bash hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">#/usr/local/nginx/conf.d/default.conf(一些常用的配置功能，供参考)</span></span><br><span class="line">server &#123;</span><br><span class="line">        listen       80 ;</span><br><span class="line">        listen       443 ssl;</span><br><span class="line">        server_name www.test1.com www.test2.com;</span><br><span class="line">        server_tag   off;</span><br><span class="line">        req_status server;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-comment"># 开启https的配置,证书存放位置需要规范</span></span><br><span class="line">        <span class="hljs-comment"># ssl                  on;</span></span><br><span class="line">        ssl_certificate      /usr/<span class="hljs-built_in">local</span>/nginx/certs/test.crt;</span><br><span class="line">        ssl_certificate_key  /usr/<span class="hljs-built_in">local</span>/nginx/certs/test.key;</span><br><span class="line">        ssl_session_timeout  5m;</span><br><span class="line">        ssl_protocols  SSLv2 SSLv3 TLSv1 TLSv1.1 TLSv1.2;</span><br><span class="line">        ssl_ciphers  ALL:!ADH:!EXPORT56:RC4+RSA:+HIGH:+MEDIUM:+LOW:+SSLv2:+EXP;</span><br><span class="line">        ssl_prefer_server_ciphers   on;</span><br><span class="line">        <span class="hljs-comment">#配置本监听端口下的日志</span></span><br><span class="line">        access_log  logs/host.access.log  main; </span><br><span class="line"></span><br><span class="line">        location /example &#123;</span><br><span class="line"></span><br><span class="line">        root   html;</span><br><span class="line">        index  index.html index.htm;</span><br><span class="line">        <span class="hljs-comment"># 最多 5 个排队， 由于每秒处理 10 个请求 + 5个排队，你一秒最多发送 15 个请求过来，再多就直接返回 503 错误给你了</span></span><br><span class="line">        <span class="hljs-comment"># limit_req zone=ConnLimitZone burst=5 nodelay;</span></span><br><span class="line"></span><br><span class="line">        <span class="hljs-comment"># 用于获取用户真实IP，传给后端的服务器获取</span></span><br><span class="line">        proxy_set_header            Host <span class="hljs-variable">$host</span>;</span><br><span class="line">        proxy_set_header            X-real-ip <span class="hljs-variable">$remote_addr</span>;</span><br><span class="line">        proxy_set_header            X-Forwarded-For <span class="hljs-variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-comment"># 开启与后端tomcat长连接需下面两个指令,tomcat也需要配置长连接参数(tomcat在server.xml配置标签 &lt;Connector  keepAliveTimeout="20000"   maxKeepAliveRequests="3000" /&gt;)</span></span><br><span class="line">        proxy_http_version 1.1;</span><br><span class="line">        proxy_set_header Connection <span class="hljs-string">""</span>;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-comment"># 反向代理指令，记得proxy_pass 带uri和不带uri的区别</span></span><br><span class="line">        <span class="hljs-comment">#proxy_pass http://bakend/ ;  #与负载均衡结合使用</span></span><br><span class="line">        proxy_pass http://192.168.31.11:7111/ ;</span><br><span class="line">        <span class="hljs-comment"># 用户访问局部限制指令,匹配上的立马匹配，不继续下面的匹配动作</span></span><br><span class="line">        allow 192.168.31.69;</span><br><span class="line">        deny all;</span><br><span class="line">        deny 192.168.31.70;</span><br><span class="line">        allow all;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-comment"># 传输数据限速到20k,为了测试很明显就把此值调的很低</span></span><br><span class="line">        limit_rate 20k;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-comment"># 数据合并发送</span></span><br><span class="line">        <span class="hljs-comment"># 合并js css,需要开发合并文件，暂时使用不了</span></span><br><span class="line">        concat on;</span><br><span class="line">        concat_max_files 20;</span><br><span class="line">        concat_unique off;</span><br><span class="line">        concat_delimiter <span class="hljs-string">"\r\n"</span>;</span><br><span class="line">        concat_ignore_file_error on;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-comment">#配置web缓存,与主配置文件配置的缓存目录结合使用。缓存也就是将js、css、image等静态文件从tomcat缓存到nginx指定的缓存目录下，既可以减轻tomcat负担，也可以加快访问速度，</span></span><br><span class="line">        <span class="hljs-comment">#但这样缓存及时清理成为了一个问题，所以需要 ngx_cache_purge 这个模块来在过期时间未到之前，手动清理缓存。（有篇文章http://quenlang.blog.51cto.com/4813803/1570671，</span></span><br><span class="line">        <span class="hljs-comment">#对比使用缓存、不使用缓存、使用动静分离三种情况下，高并发性能比较。使用代理缓存功能性能会高出很多倍）</span></span><br><span class="line">        <span class="hljs-comment">#反向代理到哪台机器</span></span><br><span class="line">        proxy_pass  http://192.168.31.11;</span><br><span class="line">        <span class="hljs-comment">#不显示重定向信息</span></span><br><span class="line">        proxy_redirect off;</span><br><span class="line">        <span class="hljs-comment">#设置请求头,获取用户真实IP</span></span><br><span class="line">        proxy_set_header Host <span class="hljs-variable">$host</span>;</span><br><span class="line">        proxy_set_header   X-Real-IP   <span class="hljs-variable">$remote_addr</span>;</span><br><span class="line">        proxy_set_header   X-Forwarded-For <span class="hljs-variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-comment">#引用前面定义的缓存区 cache_one</span></span><br><span class="line">        proxy_cache cache_one;</span><br><span class="line">        <span class="hljs-comment">#增加头部记录缓存命中率</span></span><br><span class="line">        add_header Nginx-Cache <span class="hljs-variable">$upstream_cache_status</span>;</span><br><span class="line">        <span class="hljs-comment">#proxy_cache_valid ： 为不同的响应状态码设置不同的缓存时间，比如200、302等正常结果可以缓存的时间长点，而404、500等缓存时间设置短一些，这个时间到了文件就会过期，而不论是否刚被访问过。</span></span><br><span class="line">        proxy_cache_valid  200 304 301 302 8h;</span><br><span class="line">        proxy_cache_valid 404 1m;  </span><br><span class="line">        proxy_cache_valid  any 2d;</span><br><span class="line">        <span class="hljs-comment">#定义cache_key</span></span><br><span class="line">        proxy_cache_key <span class="hljs-variable">$host</span><span class="hljs-variable">$uri</span><span class="hljs-variable">$is_args</span><span class="hljs-variable">$args</span>;</span><br><span class="line">        <span class="hljs-comment">#返回给客户端的浏览器缓存失效时间,指的是静态资源的缓存</span></span><br><span class="line">        expires 30d;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-comment">#清除缓存。下面配置的proxy_cache_purge指令用于方便的清除缓存，但必须按装第三方的 ngx_cache_purge 模块才能使用，项目地址：https://github.com/FRiCKLE/ngx_cache_purge/ 。</span></span><br><span class="line">        location ~ /purge(/.*) &#123;</span><br><span class="line">            <span class="hljs-comment">#设置只允许指定的IP或IP段才可以清除URL缓存。</span></span><br><span class="line">            allow   127.0.0.1;</span><br><span class="line">            allow   192.168.31.0/24;</span><br><span class="line">            deny    all;</span><br><span class="line">            proxy_cache_purge  cache_one <span class="hljs-variable">$host</span><span class="hljs-variable">$1</span><span class="hljs-variable">$is_args</span><span class="hljs-variable">$args</span>;</span><br><span class="line">            error_page 405 =200 /purge<span class="hljs-variable">$1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-comment"># 图片防盗链配置</span></span><br><span class="line">        location ~* \.(gif|jpg|png|bmp)$ &#123;</span><br><span class="line">        root html;</span><br><span class="line">        valid_referers none blocked *.feidee.com server_names ~\.google\. ~\.baidu\.;</span><br><span class="line">        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$invalid_referer</span>) &#123;</span><br><span class="line">        <span class="hljs-built_in">return</span> 403;</span><br><span class="line">        <span class="hljs-comment">#rewrite ^/ http://xxxx/403.jpg;</span></span><br><span class="line">            &#125;</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">        location /realip &#123;</span><br><span class="line">        <span class="hljs-comment">#如果是作为代理，下面三句才会把客户端的IP带到真正的服务器上面</span></span><br><span class="line">        proxy_set_header            Host <span class="hljs-variable">$host</span>;</span><br><span class="line">        proxy_set_header            X-real-ip <span class="hljs-variable">$remote_addr</span>;</span><br><span class="line">        proxy_set_header            X-Forwarded-For <span class="hljs-variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">        proxy_pass http://192.168.31.11/realip/;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">        error_page  404              /404.html;</span><br><span class="line">        <span class="hljs-comment"># redirect server error pages to the static page /50x.html</span></span><br><span class="line">        error_page   500 502 503 504  /50x.html;</span><br><span class="line">        location = /50x.html &#123;</span><br><span class="line">            root   html;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h3 id="7-Tengine-安全防护"><a href="#7-Tengine-安全防护" class="headerlink" title="7.Tengine 安全防护"></a><em>7.Tengine 安全防护</em></h3><h4 id="7-1-禁止web服务IP直接访问"><a href="#7-1-禁止web服务IP直接访问" class="headerlink" title="7.1 禁止web服务IP直接访问"></a><em>7.1 禁止web服务IP直接访问</em></h4><figure class="highlight bash hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">#/usr/local/nginx/conf.d/defend.conf(禁止IP直接访问配置，默认开启)</span></span><br><span class="line"><span class="hljs-comment">#Nginx配置禁止IP直接访问，如果是直接使用IP访问，直接返回客户端403错误</span></span><br><span class="line"><span class="hljs-comment">#注意:对于https，必须指定证书，否则连域名访问也会一起禁止</span></span><br><span class="line">server  </span><br><span class="line">    &#123;  </span><br><span class="line">        listen 80 default;  </span><br><span class="line">        <span class="hljs-comment">#server_name _;</span></span><br><span class="line">        <span class="hljs-built_in">return</span> 403;  </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">server</span><br><span class="line">    &#123;</span><br><span class="line">        listen 443 default;</span><br><span class="line">        <span class="hljs-comment">#server_name _;</span></span><br><span class="line">        ssl_certificate      /usr/<span class="hljs-built_in">local</span>/nginx/certs/test.crt;</span><br><span class="line">        ssl_certificate_key  /usr/<span class="hljs-built_in">local</span>/nginx/certs/test.key;</span><br><span class="line">        <span class="hljs-built_in">return</span> 403;</span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure>

<h4 id="7-2-连接和请求数限制"><a href="#7-2-连接和请求数限制" class="headerlink" title="7.2 连接和请求数限制"></a><em>7.2 连接和请求数限制</em></h4><figure class="highlight bash hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">#/usr/local/nginx/conf.d/limit_rate.conf(连接和请求数限制脚本，默认关闭)</span></span><br><span class="line"><span class="hljs-comment"># 这里取得原始用户的IP地址</span></span><br><span class="line">map <span class="hljs-variable">$http_x_forwarded_for</span>  <span class="hljs-variable">$clientRealIp</span> &#123;</span><br><span class="line">       <span class="hljs-string">""</span>      <span class="hljs-variable">$remote_addr</span>;</span><br><span class="line">       ~^(?P&lt;firstAddr&gt;[0-9\.]+),?.*$  <span class="hljs-variable">$firstAddr</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="hljs-comment"># 设置白名单</span></span><br><span class="line">geo <span class="hljs-variable">$clientRealIp</span>  <span class="hljs-variable">$whiteiplist</span>  &#123;</span><br><span class="line">    default 1;</span><br><span class="line">    192.168.31.241 1;</span><br><span class="line">    192.168.31.251 0;</span><br><span class="line">    192.168.31.236 0;</span><br><span class="line">    192.168.31.0/24 0;</span><br><span class="line">      &#125;</span><br><span class="line">map <span class="hljs-variable">$whiteiplist</span>  <span class="hljs-variable">$limit</span> &#123;</span><br><span class="line">    1 <span class="hljs-variable">$clientRealIp</span>;</span><br><span class="line">    0 <span class="hljs-string">""</span>;</span><br><span class="line">      &#125;</span><br><span class="line"><span class="hljs-comment">#       server 段配置</span></span><br><span class="line"><span class="hljs-comment">#       if ( $whiteiplist = 0 )&#123;</span></span><br><span class="line"><span class="hljs-comment">#       return 403;</span></span><br><span class="line"><span class="hljs-comment">#       &#125;</span></span><br><span class="line"><span class="hljs-comment">#       if ( $http_user_agent ~  Dalvik.* )&#123;</span></span><br><span class="line"><span class="hljs-comment">#       return 403;</span></span><br><span class="line"><span class="hljs-comment">#       &#125;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="hljs-comment"># 针对原始用户 IP 地址做限制</span></span><br><span class="line">limit_conn_zone <span class="hljs-variable">$limit</span> zone=TotalConnLimitZone:20m ;</span><br><span class="line">limit_conn  TotalConnLimitZone  50; <span class="hljs-comment"># 每个IP最大连接数</span></span><br><span class="line">limit_conn_log_level notice;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment"># 针对原始用户 IP 地址做限制</span></span><br><span class="line">limit_req_zone <span class="hljs-variable">$limit</span> zone=ConnLimitZone:20m  rate=20r/s; <span class="hljs-comment">#每个地址每秒只能请求同一个URL20次</span></span><br><span class="line">limit_req zone=ConnLimitZone burst=10 nodelay; <span class="hljs-comment"># 如果开启此条规则，burst=10的限制将会在nginx全局生效 一共有10块令牌,并且每秒钟只新增1块令牌,10块令牌发完后 多出来的那些请求就会返回503.</span></span><br><span class="line">limit_req_log_level notice;</span><br></pre></td></tr></table></figure>

<h4 id="7-3-访问全站IP黑名单限制"><a href="#7-3-访问全站IP黑名单限制" class="headerlink" title="7.3 访问全站IP黑名单限制"></a><em>7.3 访问全站IP黑名单限制</em></h4><figure class="highlight bash hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">#/usr/local/nginx/conf.d/globle_blacklistip.conf(访问全站限制IP)</span></span><br><span class="line"><span class="hljs-comment">#配置全局的对网站访问的限制，对特定的url进行访问限制可以在location里面进行配置</span></span><br><span class="line"><span class="hljs-comment">#############globle setting ##########</span></span><br><span class="line">deny 192.168.31.69;</span><br><span class="line">deny 192.168.31.70;</span><br><span class="line"><span class="hljs-comment">#deny 192.168.31.0/24 ;</span></span><br><span class="line">allow all;</span><br></pre></td></tr></table></figure>

<h4 id="7-4-下载防盗链配置"><a href="#7-4-下载防盗链配置" class="headerlink" title="7.4 下载防盗链配置"></a><em>7.4 下载防盗链配置</em></h4><figure class="highlight bash hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">#/usr/local/nginx/conf.d/secure_link.conf(下载防盗链配置)</span></span><br><span class="line">nginx 配置如下:</span><br><span class="line">server &#123;</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  www.testchao.com <span class="hljs-comment">#本机域名</span></span><br><span class="line">    access_log  ../logs/ www.testchao.com.access.log  main; <span class="hljs-comment">#日志</span></span><br><span class="line">    location / &#123;</span><br><span class="line">        root html;</span><br><span class="line">        <span class="hljs-comment">#md5_hash[,expiration_time] MD5哈希值和过期时间</span></span><br><span class="line">        secure_link <span class="hljs-variable">$arg_st</span>,<span class="hljs-variable">$arg_e</span>;</span><br><span class="line">         <span class="hljs-comment">#md5值对比结果,使用上面提供的uri、密钥、过期时间生成md5哈希值.如果它生成的md5哈希值与用户提交过来的哈希值一致，那么这个变量的值为1，否则为0</span></span><br><span class="line">        secure_link_md5 ttlsa.com<span class="hljs-variable">$uri</span><span class="hljs-variable">$arg_e</span>;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$secure_link</span> = <span class="hljs-string">""</span>) &#123;</span><br><span class="line">            <span class="hljs-built_in">return</span> 403;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$secure_link</span> = <span class="hljs-string">"0"</span>) &#123;</span><br><span class="line">            <span class="hljs-built_in">return</span> 403;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">     <span class="hljs-comment">#php解析</span></span><br><span class="line">    location ~ \.php$ &#123;</span><br><span class="line">        root           html;</span><br><span class="line">        fastcgi_pass   127.0.0.1:9000;</span><br><span class="line">        fastcgi_index  index.php;</span><br><span class="line">        fastcgi_param  SCRIPT_FILENAME  <span class="hljs-variable">$document_root</span>/<span class="hljs-variable">$fastcgi_script_name</span>;</span><br><span class="line">        include        fastcgi_params;</span><br><span class="line">      &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">#下载页面php如下:</span></span><br><span class="line"><span class="hljs-comment">#download.php</span></span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;br&gt;nginx下载页面</span><br><span class="line">&lt;br&gt;</span><br><span class="line">&lt;a href=<span class="hljs-string">"/test.php"</span> class=<span class="hljs-string">"btn btn-danger go-link"</span> role=<span class="hljs-string">"button"</span> target=<span class="hljs-string">"_blank"</span> rel=<span class="hljs-string">"nofollow"</span> _hover-ignore=<span class="hljs-string">"1"</span>&gt;下载地址&lt;/a&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">#test.php 生成连接页面</span></span><br><span class="line">&lt;?php</span><br><span class="line"> <span class="hljs-comment"># 作用：生成nginx secure link链接</span></span><br><span class="line"> <span class="hljs-comment"># 站点：www.qingye.info</span></span><br><span class="line"> <span class="hljs-comment"># 作者：青叶</span></span><br><span class="line"> <span class="hljs-comment"># 时间：2020-01-12</span></span><br><span class="line"><span class="hljs-variable">$secret</span> = <span class="hljs-string">'qingye'</span>; <span class="hljs-comment"># 密钥</span></span><br><span class="line"> <span class="hljs-variable">$path</span> = <span class="hljs-string">'/web/nginx-1.4.2.tar.gz.jpg'</span>; <span class="hljs-comment"># 下载文件</span></span><br><span class="line"> <span class="hljs-comment"># 下载到期时间,time是当前时间,300表示300秒,也就是说从现在到300秒之内文件不过期</span></span><br><span class="line"> <span class="hljs-variable">$expire</span> = time()+10;</span><br><span class="line"><span class="hljs-comment"># 用文件路径、密钥、过期时间生成加密串</span></span><br><span class="line"> <span class="hljs-variable">$md5</span> = base64_encode(md5(<span class="hljs-variable">$secret</span> . <span class="hljs-variable">$path</span> . <span class="hljs-variable">$expire</span> .<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">'REMOTE_ADDR'</span>], <span class="hljs-literal">true</span>));</span><br><span class="line"> <span class="hljs-variable">$md5</span> = strtr(<span class="hljs-variable">$md5</span>, <span class="hljs-string">'+/'</span>, <span class="hljs-string">'-_'</span>);</span><br><span class="line"> <span class="hljs-variable">$md5</span> = str_replace(<span class="hljs-string">'='</span>, <span class="hljs-string">''</span>, <span class="hljs-variable">$md5</span>);</span><br><span class="line"><span class="hljs-comment"># 加密后的下载地址</span></span><br><span class="line"><span class="hljs-variable">$url</span> = http://www.qingye.info/web/nginx-1.4.2.tar.gz.jpg?st=<span class="hljs-string">'.$md5.'</span>&amp;e=<span class="hljs-string">'.$expire;</span></span><br><span class="line"><span class="hljs-string">#echo '</span>&lt;a href=http://www.qingye.info/web/nginx-1.4.2.tar.gz.jpg?st=<span class="hljs-string">'.$md5.'</span>&amp;e=<span class="hljs-string">'.$expire.'</span>&gt;nginx-1.4.2&lt;/a&gt;<span class="hljs-string">';</span></span><br><span class="line"><span class="hljs-string">#echo '</span>&lt;br&gt;http://www.qingye.info/web/nginx-1.4.2.tar.gz.jpg?st=<span class="hljs-string">'.$md5.'</span>&amp;e=<span class="hljs-string">'.$expire;</span></span><br><span class="line"><span class="hljs-string">header("Location: $url");</span></span><br><span class="line"><span class="hljs-string"> ?&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="8-Tengine-重要模块"><a href="#8-Tengine-重要模块" class="headerlink" title="8.Tengine 重要模块"></a><em>8.Tengine 重要模块</em></h3><h4 id="8-1-upstream负载均衡模块"><a href="#8-1-upstream负载均衡模块" class="headerlink" title="8.1 upstream负载均衡模块"></a><em>8.1 upstream负载均衡模块</em></h4><figure class="highlight bash hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">#upstream模块详细例子</span></span><br><span class="line">upstream backend &#123;</span><br><span class="line"><span class="hljs-comment">#负载均衡算法，这个ip_hash根据IP来辨别，有时候因为访问都是从cdn或其他同一个IP过来，导致负载均衡发挥不好</span></span><br><span class="line">ip_hash;</span><br><span class="line">server 192.168.31.225:8080 weight 2;</span><br><span class="line">server 192.168.31.226:8080 weight=1 max_fails=2 fail_timeout=30s ;</span><br><span class="line">server 192.168.31.227:8080 backup;</span><br><span class="line">  &#125;</span><br><span class="line">server &#123;</span><br><span class="line">location / &#123;</span><br><span class="line">proxy_pass http://backend;</span><br><span class="line">proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">#weight ： 轮询权值也是可以用在ip_hash的，默认值为1</span></span><br><span class="line"><span class="hljs-comment">#max_fails ： 允许请求失败的次数，默认为1。当超过最大次数时，返回proxy_next_upstream 模块定义的错误。</span></span><br><span class="line"><span class="hljs-comment">#fail_timeout ： 有两层含义，一是在 30s 时间内最多容许 2 次失败；二是在经历了 2 次失败以后，30s时间内不分配请求到这台服务器。</span></span><br><span class="line"><span class="hljs-comment">#backup ： 预留的备份机器。当其他所有的非backup机器出现故障的时候，才会请求backup机器，因此这台机器的压力最轻。（为什么我的1.6.3版本里配置backup启动nginx时说invalid parameter "backup"？）</span></span><br><span class="line"><span class="hljs-comment">#max_conns： 限制同时连接到某台后端服务器的连接数，默认为0即无限制。因为queue指令是commercial，所以还是保持默认吧。</span></span><br><span class="line"><span class="hljs-comment">#proxy_next_upstream ： 这个指令属于 http_proxy 模块的，指定后端返回什么样的异常响应时，使用另一个realserver</span></span><br></pre></td></tr></table></figure>

<p>关于nginx使用负载均衡会话跟踪问题(ngx_http_upstream_session_sticky_module  模块，tenginx默认已经安装)</p>
<p>这个模块的作用是通过cookie黏贴的方式将来自同一个客户端（浏览器）的请求发送到同一个后端服务器上处理，这样一定程度上可以解决多个backend servers的session同步的问题 —— 因为不再需要同步，</p>
<p>而RR轮询模式(nginx的默认后端调度模式)必须要运维人员自己考虑session同步的实现。</p>
<p>语法：session_sticky [cookie=name] [domain=your_domain] [path=your_path] [maxage=time] [mode=insert|rewrite|prefix] [option=indirect] [maxidle=time] [maxlife=time] [fallback=on|off] [hash=plain|md5]<br>默认值：session_sticky cookie=route mode=insert fallback=on<br>上下文：upstream</p>
<p>说明:</p>
<p>本指令可以打开会话保持的功能，下面是具体的参数：</p>
<p>cookie设置用来记录会话的cookie名称</p>
<p>domain设置cookie作用的域名，默认不设置</p>
<p>path设置cookie作用的URL路径，默认不设置</p>
<p>maxage设置cookie的生存期，默认不设置，即为session cookie，浏览器关闭即失效</p>
<p>mode设置cookie的模式:</p>
<p>insert: 在回复中本模块通过Set-Cookie头直接插入相应名称的cookie。</p>
<p>prefix: 不会生成新的cookie，但会在响应的cookie值前面加上特定的前缀，当浏览器带着这个有特定标识的cookie再次请求时，模块在传给后端服务前先删除加入的前缀，后端服务拿到的还是原来的cookie值，这些动作对后端透明。如：”Cookie: NAME=SRV~VALUE”。</p>
<p>rewrite: 使用服务端标识覆盖后端设置的用于session sticky的cookie。如果后端服务在响应头中没有设置该cookie，则认为该请求不需要进行session sticky，使用这种模式，后端服务可以控制哪些请求需要sesstion sticky，哪些请求不需要。</p>
<p>option 设置用于session sticky的cookie的选项，可设置成indirect或direct。indirect不会将session sticky的cookie传送给后端服务，该cookie对后端应用完全透明。direct则与indirect相反。</p>
<p>maxidle设置session cookie的最长空闲的超时时间</p>
<p>maxlife设置session cookie的最长生存期</p>
<p>fallback设置是否重试其他机器，当sticky的后端机器挂了以后，是否需要尝试其他机器</p>
<p>hash 设置cookie中server标识是用明文还是使用md5值，默认使用md5<br>maxage是cookie的生存期。不设置时，浏览器或App关闭后就失效。下次启动时，又会随机分配后端服务器。所以如果希望该客户端的请求长期落在同一台后端服务器上，可以设置maxage。</p>
<p>hash不论是明文还是hash值，都有固定的数目。因为hash是server的标识，所以有多少个server，就有等同数量的hash值。</p>
<p>一些例外：</p>
<p>同一客户端的请求，有可能落在不同的后端服务器上## 如果客户端启动时同时发起多个请求。由于这些请求都没带cookie，所以服务器会随机选择后端服务器，返回不同的cookie。当这些请求中的最后一个请求返回时，客户端的cookie才会稳定下来，值以最后返回的cookie为准。</p>
<p>cookie不一定生效## 由于cookie最初由服务器端下发，如果客户端禁用cookie，则cookie不会生效。</p>
<p>客户端可能不带cookie## Android客户端发送请求时，一般不会带上所有的cookie，需要明确指定哪些cookie会带上。如果希望用sticky做负载均衡，请对Android开发说加上cookie。</p>
<p>注意事项：</p>
<p>cookie名称不要和业务使用的cookie重名。Sticky默认的cookie名称是route，可以改成任何值。但切记，不可以与业务中使用的cookie重名。<br>客户端发的第一个请求是不带cookie的。服务器下发的cookie，在客户端下一次请求时才能生效<br>另外内置的 ip_hash 也可以实现根据客户端IP来分发请求，但它很容易造成负载不均衡的情况，而如果nginx前面有CDN网络或者来自同一局域网的访问，它接收的客户端IP是一样的，容易造成负载不均衡现象。</p>
<p>这个模块并不合适不支持 Cookie 或手动禁用了cookie的浏览器，此时默认session_sticky就会切换成RR。它不能与ip_hash同时使用。</p>
<figure class="highlight bash hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">upstream backend &#123;</span><br><span class="line">    check interval=3000 rise=2 fall=5 timeout=1000 <span class="hljs-built_in">type</span>=http;</span><br><span class="line">    check_http_send <span class="hljs-string">"HEAD / HTTP/1.0\r\n\r\n"</span>;</span><br><span class="line">    check_http_expect_alive http_2xx http_3xx;</span><br><span class="line">    server 192.168.31.226:8080 weight=1;</span><br><span class="line">    server 192.168.31.227:8080 weight=1;</span><br><span class="line">    session_sticky;</span><br><span class="line"><span class="hljs-comment">#在insert + indirect模式或者prefix模式下需要配置session_sticky_hide_cookie</span></span><br><span class="line"><span class="hljs-comment">#这种模式不会将保持会话使用的cookie传给后端服务，让保持会话的cookie对后端透明</span></span><br><span class="line"><span class="hljs-comment">#session_sticky cookie=uid fallback=on mode=insert option=indirect hash=plain;</span></span><br><span class="line"><span class="hljs-comment">#配置起来超级简单，一般来说一个session_sticky指令就够了。</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>负载均衡其它调度方案</p>
<ul>
<li><p>轮询（默认） ： 每个请求按时间顺序逐一分配到不同的后端服务器，如果后端某台服务器宕机，故障系统被自动剔除，使用户访问不受影响。Weight 指定轮询权值，Weight值越大，分配到的访问机率越高，主要用于后端每个服务器性能不均的情况下。</p>
</li>
<li><p>ip_hash ： 每个请求按访问IP的hash结果分配，这样来自同一个IP的访客固定访问一个后端服务器，有效解决了动态网页存在的session共享问题。当然如果这个节点不可用了，会发到下个节点，而此时没有session同步的话就注销掉了。</p>
</li>
<li><p>least_conn ： 请求被发送到当前活跃连接最少的realserver上。会考虑weight的值。</p>
</li>
<li><p>url_hash ： 此方法按访问url的hash结果来分配请求，使每个url定向到同一个后端服务器，可以进一步提高后端缓存服务器的效率。Nginx本身是不支持url_hash的，如果需要使用这种调度算法，必须安装Nginx 的hash软件包 nginx_upstream_hash 。</p>
</li>
<li><p>fair ： 这是比上面两个更加智能的负载均衡算法。此种算法可以依据页面大小和加载时间长短智能地进行负载均衡，也就是根据后端服务器的响应时间来分配请求，响应时间短的优先分配。<br>Nginx本身是不支持fair的，如果需要使用这种调度算法，必须下载Nginx的 upstream_fair 模块</p>
</li>
</ul>
<h4 id="8-2-rewrite重写模块"><a href="#8-2-rewrite重写模块" class="headerlink" title="8.2 rewrite重写模块"></a><em>8.2 rewrite重写模块</em></h4><p>rewrite模块rewrite功能就是，使用nginx提供的全局变量或自己设置的变量，结合正则表达式和标志位实现url重写以及重定向。rewrite只能放在server{},location{},if{}中，<br>并且只能对域名后边的除去传递的参数外的字符串起作用，例如 <a href="http://seanlook.com/a/we/index.php?id=1&amp;u=str" target="_blank" rel="noopener">http://seanlook.com/a/we/index.php?id=1&amp;u=str</a> 只对/a/we/index.php重写。语法rewrite regex replacement [flag];</p>
<p>flag标志位</p>
<figure class="highlight yaml hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-attr">last :</span> <span class="hljs-string">相当于Apache的[L]标记，表示完成rewrite</span></span><br><span class="line"><span class="hljs-attr">break :</span> <span class="hljs-string">停止执行当前虚拟主机的后续rewrite指令集</span></span><br><span class="line"><span class="hljs-attr">redirect :</span> <span class="hljs-string">返回302临时重定向，地址栏会显示跳转后的地址</span></span><br><span class="line"><span class="hljs-attr">permanent :</span> <span class="hljs-string">返回301永久重定向，地址栏会显示跳转后的地址</span></span><br></pre></td></tr></table></figure>

<p>if指令与全局变量,if判断指令:</p>
<figure class="highlight yaml hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-string">语法为if(condition)&#123;...&#125;，对给定的条件condition进行判断。如果为真，大括号内的rewrite指令将被执行，if条件(conditon)可以是如下任何内容：</span></span><br><span class="line"><span class="hljs-string">当表达式只是一个变量时，如果值为空或任何以0开头的字符串都会当做false</span></span><br><span class="line"><span class="hljs-string">直接比较变量和内容时，使用=或!=</span></span><br><span class="line"><span class="hljs-string">~正则表达式匹配，~*不区分大小写的匹配，!~区分大小写的不匹配</span></span><br><span class="line"><span class="hljs-string">-f和!-f用来判断是否存在文件</span></span><br><span class="line"><span class="hljs-string">-d和!-d用来判断是否存在目录</span></span><br><span class="line"><span class="hljs-string">-e和!-e用来判断是否存在文件或目录</span></span><br><span class="line"><span class="hljs-string">-x和!-x用来判断文件是否可执行</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">if</span> (<span class="hljs-variable">$http_user_agent</span> ~ MSIE) &#123;</span><br><span class="line">    rewrite ^(.*)$ /msie/<span class="hljs-variable">$1</span> <span class="hljs-built_in">break</span>;</span><br><span class="line">&#125; //如果UA包含<span class="hljs-string">"MSIE"</span>，rewrite请求到/msid/目录下</span><br><span class="line"><span class="hljs-keyword">if</span> (<span class="hljs-variable">$http_cookie</span> ~* <span class="hljs-string">"id=([^;]+)(?:;|$)"</span>) &#123;</span><br><span class="line">    <span class="hljs-built_in">set</span> <span class="hljs-variable">$id</span> <span class="hljs-variable">$1</span>;</span><br><span class="line"> &#125; //如果cookie匹配正则，设置变量<span class="hljs-variable">$id</span>等于正则引用部分</span><br><span class="line"><span class="hljs-keyword">if</span> (<span class="hljs-variable">$request_method</span> = POST) &#123;</span><br><span class="line">    <span class="hljs-built_in">return</span> 405;</span><br><span class="line">&#125; //如果提交方法为POST，则返回状态405（Method not allowed）。<span class="hljs-built_in">return</span>不能返回301,302</span><br><span class="line"><span class="hljs-keyword">if</span> (<span class="hljs-variable">$slow</span>) &#123;</span><br><span class="line">    limit_rate 10k;</span><br><span class="line">&#125; //限速，<span class="hljs-variable">$slow</span>可以通过 <span class="hljs-built_in">set</span> 指令设置</span><br><span class="line"><span class="hljs-keyword">if</span> (!-f <span class="hljs-variable">$request_filename</span>)&#123;</span><br><span class="line">    <span class="hljs-built_in">break</span>;</span><br><span class="line">    proxy_pass  http://127.0.0.1;</span><br><span class="line">&#125; //如果请求的文件名不存在，则反向代理到localhost 。这里的<span class="hljs-built_in">break</span>也是停止rewrite检查</span><br><span class="line"><span class="hljs-keyword">if</span> (<span class="hljs-variable">$args</span> ~ post=140)&#123;</span><br><span class="line">    rewrite ^ http://example.com/ permanent;</span><br><span class="line">&#125; //如果query string中包含<span class="hljs-string">"post=140"</span>，永久重定向到example.com</span><br><span class="line">location ~* \.(gif|jpg|png|swf|flv)$ &#123;</span><br><span class="line">    valid_referers none blocked www.jefflei.com www.leizhenfang.com;</span><br><span class="line">    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$invalid_referer</span>) &#123;</span><br><span class="line">        <span class="hljs-built_in">return</span> 404;</span><br><span class="line">    &#125; //防盗链</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>下面是可以用作if判断的全局变量:</p>
<figure class="highlight yaml hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-string">$args</span> <span class="hljs-string">：</span> <span class="hljs-comment">#这个变量等于请求行中的参数，同$query_string</span></span><br><span class="line"><span class="hljs-string">$content_length</span> <span class="hljs-string">：</span> <span class="hljs-string">请求头中的Content-length字段。</span></span><br><span class="line"><span class="hljs-string">$content_type</span> <span class="hljs-string">：</span> <span class="hljs-string">请求头中的Content-Type字段。</span></span><br><span class="line"><span class="hljs-string">$document_root</span> <span class="hljs-string">：</span> <span class="hljs-string">当前请求在root指令中指定的值。</span></span><br><span class="line"><span class="hljs-string">$host</span> <span class="hljs-string">：</span> <span class="hljs-string">请求主机头字段，否则为服务器名称。</span></span><br><span class="line"><span class="hljs-string">$http_user_agent</span> <span class="hljs-string">：</span> <span class="hljs-string">客户端agent信息</span></span><br><span class="line"><span class="hljs-string">$http_cookie</span> <span class="hljs-string">：</span> <span class="hljs-string">客户端cookie信息</span></span><br><span class="line"><span class="hljs-string">$limit_rate</span> <span class="hljs-string">：</span> <span class="hljs-string">这个变量可以限制连接速率。</span></span><br><span class="line"><span class="hljs-string">$request_method</span> <span class="hljs-string">：</span> <span class="hljs-string">客户端请求的动作，通常为GET或POST。</span></span><br><span class="line"><span class="hljs-string">$remote_addr</span> <span class="hljs-string">：</span> <span class="hljs-string">客户端的IP地址。</span></span><br><span class="line"><span class="hljs-string">$remote_port</span> <span class="hljs-string">：</span> <span class="hljs-string">客户端的端口。</span></span><br><span class="line"><span class="hljs-string">$remote_user</span> <span class="hljs-string">：</span> <span class="hljs-string">已经经过Auth</span> <span class="hljs-string">Basic</span> <span class="hljs-string">Module验证的用户名。</span></span><br><span class="line"><span class="hljs-string">$request_filename</span> <span class="hljs-string">：</span> <span class="hljs-string">当前请求的文件路径，由root或alias指令与URI请求生成。</span></span><br><span class="line"><span class="hljs-string">$scheme</span> <span class="hljs-string">：</span> <span class="hljs-string">HTTP方法（如http，https）。</span></span><br><span class="line"><span class="hljs-string">$server_protocol</span> <span class="hljs-string">：</span> <span class="hljs-string">请求使用的协议，通常是HTTP/1.0或HTTP/1.1。</span></span><br><span class="line"><span class="hljs-string">$server_addr</span> <span class="hljs-string">：</span> <span class="hljs-string">服务器地址，在完成一次系统调用后可以确定这个值。</span></span><br><span class="line"><span class="hljs-string">$server_name</span> <span class="hljs-string">：</span> <span class="hljs-string">服务器名称。</span></span><br><span class="line"><span class="hljs-string">$server_port</span> <span class="hljs-string">：</span> <span class="hljs-string">请求到达服务器的端口号。</span></span><br><span class="line"><span class="hljs-string">$request_uri</span> <span class="hljs-string">：</span> <span class="hljs-string">包含请求参数的原始URI，不包含主机名，如：”/foo/bar.php?arg=baz”。</span></span><br><span class="line"><span class="hljs-string">$uri</span> <span class="hljs-string">：</span> <span class="hljs-string">不带请求参数的当前URI，$uri不包含主机名，如”/foo/bar.html”。</span></span><br><span class="line"><span class="hljs-string">$document_uri</span> <span class="hljs-string">：</span> <span class="hljs-string">与$uri相同。</span></span><br></pre></td></tr></table></figure>

<p>常用正则:</p>
<figure class="highlight yaml hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-string">.</span> <span class="hljs-string">：</span> <span class="hljs-string">匹配除换行符以外的任意字符</span></span><br><span class="line"><span class="hljs-string">?</span> <span class="hljs-string">：</span> <span class="hljs-string">重复0次或1次</span></span><br><span class="line"><span class="hljs-string">+</span> <span class="hljs-string">：</span> <span class="hljs-string">重复1次或更多次</span></span><br><span class="line"><span class="hljs-string">*</span> <span class="hljs-string">：</span> <span class="hljs-string">重复0次或更多次</span></span><br><span class="line"><span class="hljs-string">\d</span> <span class="hljs-string">：匹配数字</span></span><br><span class="line"><span class="hljs-string">^</span> <span class="hljs-string">：</span> <span class="hljs-string">匹配字符串的开始</span></span><br><span class="line"><span class="hljs-string">$</span> <span class="hljs-string">：</span> <span class="hljs-string">匹配字符串的介绍</span></span><br><span class="line"><span class="hljs-string">&#123;n&#125;</span> <span class="hljs-string">：</span> <span class="hljs-string">重复n次</span></span><br><span class="line"><span class="hljs-string">&#123;n,&#125;</span> <span class="hljs-string">：</span> <span class="hljs-string">重复n次或更多次</span></span><br><span class="line"><span class="hljs-string">[c]</span> <span class="hljs-string">：</span> <span class="hljs-string">匹配单个字符c</span></span><br><span class="line"><span class="hljs-string">[a-z]</span> <span class="hljs-string">：</span> <span class="hljs-string">匹配a-z小写字母的任意一个</span></span><br><span class="line"><span class="hljs-comment">#小括号()之间匹配的内容，可以在后面通过$1来引用，$2表示的是前面第二个()里的内容。正则里面容易让人困惑的是\转义特殊字符。</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-string">break</span></span><br><span class="line"><span class="hljs-string">语法：break</span></span><br><span class="line"><span class="hljs-string">默认值：none</span></span><br><span class="line"><span class="hljs-string">使用字段：server,</span> <span class="hljs-string">location,</span> <span class="hljs-string">if</span></span><br><span class="line"><span class="hljs-string">完成当前设置的重写规则，停止执行其他的重写规则。</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-string">return</span></span><br><span class="line"><span class="hljs-string">语法：return</span> <span class="hljs-string">code</span></span><br><span class="line"><span class="hljs-string">默认值：none</span></span><br><span class="line"><span class="hljs-string">使用字段：server,</span> <span class="hljs-string">location,</span> <span class="hljs-string">if</span></span><br><span class="line"><span class="hljs-string">停止处理并为客户端返回状态码。非标准的444状态码将关闭连接，不发送任何响应头。可以使用的状态码有：204，400，402-406，408，410,</span> <span class="hljs-number">411</span><span class="hljs-string">,</span> <span class="hljs-number">413</span><span class="hljs-string">,</span> <span class="hljs-number">416</span><span class="hljs-string">与500-504。如果状态码附带文字段落，该文本将被放置在响应主体。相反，如果状态码后面是一个URL，该URL将成为location头补值。没有状态码的URL将被视为一个302状态码。</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-string">rewrite</span></span><br><span class="line"><span class="hljs-string">语法：rewrite</span> <span class="hljs-string">regex</span> <span class="hljs-string">replacement</span> <span class="hljs-string">flag</span></span><br><span class="line"><span class="hljs-string">默认值：none</span></span><br><span class="line"><span class="hljs-string">使用字段：server,</span> <span class="hljs-string">location,</span> <span class="hljs-string">if</span></span><br><span class="line"><span class="hljs-string">按照相关的正则表达式与字符串修改URI，指令按照在配置文件中出现的顺序执行。可以在重写指令后面添加标记。</span></span><br><span class="line"><span class="hljs-string">注意：如果替换的字符串以http://开头，请求将被重定向，并且不再执行多余的rewrite指令。</span></span><br><span class="line"><span class="hljs-string">尾部的标记(flag)可以是以下的值：</span></span><br><span class="line"><span class="hljs-string">last</span> <span class="hljs-bullet">-</span> <span class="hljs-string">停止处理重写模块指令，之后搜索location与更改后的URI匹配。</span></span><br><span class="line"><span class="hljs-string">break</span> <span class="hljs-bullet">-</span> <span class="hljs-string">完成重写指令。</span></span><br><span class="line"><span class="hljs-string">redirect</span> <span class="hljs-bullet">-</span> <span class="hljs-string">返回302临时重定向，如果替换字段用http://开头则被使用。</span></span><br><span class="line"><span class="hljs-string">permanent</span> <span class="hljs-bullet">-</span> <span class="hljs-string">返回301永久重定向。</span></span><br><span class="line"><span class="hljs-string">rewrite_log</span></span><br><span class="line"><span class="hljs-string">语法：rewrite_log</span> <span class="hljs-string">on</span> <span class="hljs-string">|</span> <span class="hljs-string">off</span></span><br><span class="line"><span class="hljs-string">默认值：rewrite_log</span> <span class="hljs-string">off</span></span><br><span class="line"><span class="hljs-string">使用字段：server,</span> <span class="hljs-string">location,</span> <span class="hljs-string">if</span></span><br><span class="line"><span class="hljs-string">变量：无</span></span><br><span class="line"><span class="hljs-string">启用时将在error</span> <span class="hljs-string">log中记录notice级别的重写日志。</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-string">set</span></span><br><span class="line"><span class="hljs-string">语法：set</span> <span class="hljs-string">variable</span> <span class="hljs-string">value</span></span><br><span class="line"><span class="hljs-string">默认值：none</span></span><br><span class="line"><span class="hljs-string">使用字段：server,</span> <span class="hljs-string">location,</span> <span class="hljs-string">if</span></span><br><span class="line"><span class="hljs-string">为给定的变量设置一个特定值。</span></span><br><span class="line"><span class="hljs-string">uninitialized_variable_warn</span></span><br><span class="line"><span class="hljs-string">语法：uninitialized_variable_warn</span> <span class="hljs-string">on|off</span></span><br><span class="line"><span class="hljs-string">默认值：uninitialized_variable_warn</span> <span class="hljs-string">on</span></span><br><span class="line"><span class="hljs-string">使用字段：http,</span> <span class="hljs-string">server,</span> <span class="hljs-string">location,</span> <span class="hljs-string">if</span></span><br><span class="line"><span class="hljs-string">控制是否记录未初始化变量的警告信息。</span></span><br></pre></td></tr></table></figure>

<p>例子:</p>
<figure class="highlight bash hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">#last和break实现URL重写，浏览器地址栏URL地址不变</span></span><br><span class="line">location ~ ^/best/ &#123;</span><br><span class="line">rewrite ^/best/(.*)  /<span class="hljs-built_in">test</span>/<span class="hljs-variable">$1</span> <span class="hljs-built_in">break</span>;</span><br><span class="line">proxy_pass http://www.taob.com</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">#更换域名</span></span><br><span class="line">server&#123;</span><br><span class="line">server_name www.taob.com;</span><br><span class="line">rewrite ^/(.*)$ http://www.tb.com/<span class="hljs-variable">$1</span> permanent;</span><br><span class="line">&#125;</span><br><span class="line"><span class="hljs-comment">#或者</span></span><br><span class="line">server &#123;</span><br><span class="line">server_name www.tb.com www.taob.com;</span><br><span class="line"><span class="hljs-keyword">if</span> (<span class="hljs-variable">$host</span> != <span class="hljs-string">'www.tb.com'</span>)</span><br><span class="line">rewrite ^/(.*)$ http://www.tb.com/<span class="hljs-variable">$1</span> permanent;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="9-location-在匹配中的优先级"><a href="#9-location-在匹配中的优先级" class="headerlink" title="9.location 在匹配中的优先级"></a><em>9.location 在匹配中的优先级</em></h3><p>配置文件示例如下：</p>
<figure class="highlight bash hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">location = / &#123;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment"># 仅仅匹配请求 /</span></span><br><span class="line"></span><br><span class="line">[ configuration A ]</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">location / &#123;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment"># 匹配所有以 / 开头的请求。</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-comment"># 但是如果有更长的同类型的表达式，则选择更长的表达式。</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-comment"># 如果有正则表达式可以匹配，则优先匹配正则表达式。</span></span><br><span class="line"></span><br><span class="line">[ configuration B ]</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">location /documents/ &#123;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment"># 匹配所有以 /documents/ 开头的请求。</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-comment"># 但是如果有更长的同类型的表达式，则选择更长的表达式。</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-comment"># 如果有正则表达式可以匹配，则优先匹配正则表达式。</span></span><br><span class="line"></span><br><span class="line">[ configuration C ]</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">location ^~ /images/ &#123;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment"># 匹配所有以 /images/ 开头的表达式，如果匹配成功，则停止匹配查找。</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-comment"># 所以，即便有符合的正则表达式location，也不会被使用</span></span><br><span class="line"></span><br><span class="line">[ configuration D ]</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">location ~* \.(gif|jpg|jpeg)$ &#123;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment"># 匹配所有以 gif jpg jpeg结尾的请求。</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-comment"># 但是 以 /images/开头的请求，将使用 Configuration D</span></span><br><span class="line"></span><br><span class="line">[ configuration E ]</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> 匹配结果：</p>
<table>
<thead>
<tr>
<th>URL</th>
<th>匹配结果</th>
<th>原因</th>
</tr>
</thead>
<tbody><tr>
<td>/</td>
<td>configuration A</td>
<td>=优先级最高，匹配到结束</td>
</tr>
<tr>
<td>/index.html</td>
<td>configuration B</td>
<td>路径匹配</td>
</tr>
<tr>
<td>/documents/document.html</td>
<td>configuration C</td>
<td>第二个匹配到，往后继续匹配，发现第三个匹配最确</td>
</tr>
<tr>
<td>/images/1.gif</td>
<td>configuration D</td>
<td>同时匹配第二个，第四个，和第五个。但是由于优先级问题</td>
</tr>
<tr>
<td>/documents/1.jpg</td>
<td>configuration E</td>
<td>同时匹配第二个，第三个，和第五个。第五个是正则表达式</td>
</tr>
</tbody></table>
<p>优先级如下:</p>
<p> (location =) &gt; (location 完整路径) &gt; (location ^~ 路径) &gt; (location <del>,</del>* 正则顺序) &gt; (location 部分起始路径) &gt; (/)</p>
<p> 注： ~ 和 ~<em>都是正则匹配 其中 ~</em> 不区分大小写 ~ 区分大小写</p>
<h3 id="10-Tengine-root-和-alias-的区别"><a href="#10-Tengine-root-和-alias-的区别" class="headerlink" title="10.Tengine root 和 alias 的区别"></a><em>10.Tengine root 和 alias 的区别</em></h3><p>nginx配置下有两个指定目录的执行，root和alias</p>
<p>例如有以下配置文件：</p>
<figure class="highlight bash hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">location /img/ &#123;</span><br><span class="line">    <span class="hljs-built_in">alias</span> /var/www/image/;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>若按照上述配置的话，则访问/img/目录里面的文件时，ningx会自动去/var/www/image/目录找文件</p>
<figure class="highlight bash hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">location /img/ &#123;</span><br><span class="line">    root /var/www/image;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>若按照这种配置的话，则访问/img/目录下的文件时，nginx会去/var/www/image/img/目录下找文件。alias是一个目录别名的定义，root则是最上层目录的定义<br>还有一个重要的区别是alias后面必须要用“/”结束，否则会找不到文件的。。。而root则可有可无</p>
<h3 id="11-Tengine-TCP转发配置"><a href="#11-Tengine-TCP转发配置" class="headerlink" title="11.Tengine TCP转发配置"></a><em>11.Tengine TCP转发配置</em></h3><figure class="highlight yaml hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">#nginx tcp 配置，这一段必须放在http上下文</span></span><br><span class="line"><span class="hljs-string">tcp</span> <span class="hljs-string">&#123;</span></span><br><span class="line"><span class="hljs-string">timeout</span> <span class="hljs-string">1d;</span></span><br><span class="line"><span class="hljs-string">proxy_read_timeout</span> <span class="hljs-string">10d;</span></span><br><span class="line"><span class="hljs-string">proxy_send_timeout</span> <span class="hljs-string">10d;</span></span><br><span class="line"><span class="hljs-string">proxy_connect_timeout</span> <span class="hljs-number">30</span><span class="hljs-string">;</span></span><br><span class="line"><span class="hljs-string">upstream</span> <span class="hljs-string">api_server</span> <span class="hljs-string">&#123;</span></span><br><span class="line"><span class="hljs-string">server</span> <span class="hljs-number">192.168</span><span class="hljs-number">.31</span><span class="hljs-number">.212</span><span class="hljs-string">:389</span> <span class="hljs-string">weight=5</span> <span class="hljs-string">max_fails=1</span> <span class="hljs-string">fail_timeout=10s;</span></span><br><span class="line"><span class="hljs-string">&#125;</span></span><br><span class="line"><span class="hljs-string">server</span> <span class="hljs-string">&#123;</span></span><br><span class="line"><span class="hljs-string">listen</span> <span class="hljs-number">1389</span><span class="hljs-string">;</span></span><br><span class="line"><span class="hljs-string">proxy_connect_timeout</span> <span class="hljs-string">1s;</span></span><br><span class="line"><span class="hljs-string">proxy_pass</span> <span class="hljs-string">api_server;</span></span><br><span class="line">  <span class="hljs-string">&#125;</span></span><br><span class="line"><span class="hljs-string">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="12-Tengine-常用维护脚本或命令"><a href="#12-Tengine-常用维护脚本或命令" class="headerlink" title="12.Tengine 常用维护脚本或命令"></a><em>12.Tengine 常用维护脚本或命令</em></h3><figure class="highlight bash hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">#1、查看安装的模块</span></span><br><span class="line"></span><br><span class="line">/usr/<span class="hljs-built_in">local</span>/nginx/sbin/nginx -m</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">#2、检测配置文件语法</span></span><br><span class="line"></span><br><span class="line">/usr/<span class="hljs-built_in">local</span>/nginx/sbin/nginx -t</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">#3、启动tenginx</span></span><br><span class="line"></span><br><span class="line">/usr/<span class="hljs-built_in">local</span>/nginx/sbin/nginx</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">#4、配置文件重新加载</span></span><br><span class="line"></span><br><span class="line">/usr/<span class="hljs-built_in">local</span>/nginx/sbin/nginx -s reload</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">#5、关闭nginx</span></span><br><span class="line"></span><br><span class="line">/usr/<span class="hljs-built_in">local</span>/nginx/sbin/nginx  -s stop</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">#6、日志备份脚本</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-comment"># /bin/bash</span></span><br><span class="line"></span><br><span class="line">logs_path=<span class="hljs-string">"/usr/local/nginx/logs/"</span></span><br><span class="line"></span><br><span class="line">pid_path=<span class="hljs-string">"/usr/local/nginx/logs/nginx.pid"</span></span><br><span class="line"></span><br><span class="line">cut_path=<span class="hljs-string">"/usr/local/nginx/logs/bak/"</span></span><br><span class="line"></span><br><span class="line">[ -e <span class="hljs-variable">$cut_path</span> ] || mkdir -p <span class="hljs-variable">$cut_path</span></span><br><span class="line"> </span><br><span class="line"><span class="hljs-built_in">cd</span> <span class="hljs-variable">$logs_path</span></span><br><span class="line"><span class="hljs-keyword">for</span> log_name <span class="hljs-keyword">in</span> `ls *.<span class="hljs-built_in">log</span>`;<span class="hljs-keyword">do</span></span><br><span class="line">	mv <span class="hljs-variable">$&#123;logs_path&#125;</span><span class="hljs-variable">$&#123;log_name&#125;</span> <span class="hljs-variable">$&#123;cut_path&#125;</span><span class="hljs-variable">$&#123;log_name&#125;</span>_$(date  +<span class="hljs-string">"%Y-%m-%d"</span>).<span class="hljs-built_in">log</span></span><br><span class="line"><span class="hljs-keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">if</span> [[ -s <span class="hljs-variable">$pid_path</span> ]]; <span class="hljs-keyword">then</span></span><br><span class="line">	<span class="hljs-built_in">kill</span> -USR1 `cat <span class="hljs-variable">$&#123;pid_path&#125;</span>`</span><br><span class="line"><span class="hljs-keyword">fi</span></span><br><span class="line"></span><br><span class="line">find  <span class="hljs-variable">$&#123;cut_path&#125;</span> -<span class="hljs-built_in">type</span> f -name <span class="hljs-string">"*.log"</span> -mtime +7 | xargs rm -f</span><br></pre></td></tr></table></figure>

<h3 id="13-参考文档"><a href="#13-参考文档" class="headerlink" title="13.参考文档"></a><em>13.参考文档</em></h3><ul>
<li><a href="http://tengine.taobao.org/documentation_cn.html" target="_blank" rel="noopener">http://tengine.taobao.org/documentation_cn.html</a></li>
</ul>

        </div>
        
        <div class="level is-size-7 is-uppercase">
            <div class="level-start">
                <div class="level-item">
                    <span class="is-size-6 has-text-grey has-mr-7">#</span>
                    <a class="has-link-grey -link" href="/tags/linux/" rel="tag">linux</a>, <a class="has-link-grey -link" href="/tags/nginx/" rel="tag">nginx</a>, <a class="has-link-grey -link" href="/tags/tengine/" rel="tag">tengine</a>
                </div>
            </div>
        </div>
        
        
        
        <div class="social-share"></div>
<link rel="stylesheet" href="https://unpkg.com/social-share.js@1.0.16/dist/css/share.min.css">
<script src="https://unpkg.com/social-share.js@1.0.16/dist/js/social-share.min.js"></script>
        
    </div>
</div>





<div class="card card-transparent">
    <div class="level post-navigation is-flex-wrap is-mobile">
        
        <div class="level-start">
            <a class="level level-item has-link-grey  article-nav-prev" href="/2020/01/14/rkhunter/">
                <i class="level-item fas fa-chevron-left"></i>
                <span class="level-item">rkhunter安装和使用</span>
            </a>
        </div>
        
        
        <div class="level-end">
            <a class="level level-item has-link-grey  article-nav-next" href="/2019/11/05/tengine-http2/">
                <span class="level-item">Centos6 Tengine开启http2传输协议</span>
                <i class="level-item fas fa-chevron-right"></i>
            </a>
        </div>
        
    </div>
</div>



<div class="card">
    <div class="card-content">
        <h3 class="title is-5 has-text-weight-normal">评论</h3>
        
<div id="valine-thread" class="content"></div>
<script src="//cdn.jsdelivr.net/npm/leancloud-storage@3.15.0/dist/av-min.js"></script>
<script src='//unpkg.com/valine@1.3.9/dist/Valine.min.js'></script>
<script>
    new Valine({
        el: '#valine-thread' ,
        notify: false,
        verify: false,
        app_id: '9j93r3FqeWzjXbi3nuwAwDCD-gzGzoHsz',
        app_key: 'fUjLlCkl3zfE6aFKSN3pbeNn',
        placeholder: '发表您的意见，让我们一起交流，共同提高吧...'
    });   
</script>

    </div>
</div>
</div>
                




<div class="column is-4-tablet is-3-desktop is-3-widescreen  has-order-1 column-left is-sticky">
    
        
<div class="card widget">
    <div class="card-content">
        <nav class="level">
            <div class="level-item has-text-centered">
                <div>
                    
                        <img id="blog-head-img" class="image is-128x128 has-mb-6" src="/images/avatar.png" alt="青叶的博客">
                    
                    
                    <p class="is-size-5 is-block" style="margin-top: 10px;">
                        青叶的博客
                    </p>
                    
                    
                    <p class="is-size-6 is-block" style="margin-top: 5px;">
                        Do Something...
                    </p>
                    
                    
                    <p class="is-size-6 is-flex is-flex-center has-text-grey" style="margin-top: 5px;">
                        <i class="fas fa-map-marker-alt has-mr-7"></i>
                        <span>&nbsp;&nbsp;广东 . 深圳</span>
                    </p>
                    
                </div>
            </div>
        </nav>
        <nav class="level is-mobile">
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        文章
                    </p>
                    <p class="title has-text-weight-normal">
                        7
                    </p>
                </div>
            </div>
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        分类
                    </p>
                    <p class="title has-text-weight-normal">
                        5
                    </p>
                </div>
            </div>
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        标签
                    </p>
                    <p class="title has-text-weight-normal">
                        11
                    </p>
                </div>
            </div>
        </nav>
        <div id="knowledge-star">
            <div class="level">
                <a class="level-item button is-link is-rounded" href="http://cloud.qingye.info/images/20191105/weixinggongzhonghao.png" target="_blank">
                    关注博主微信公众号</a>
            </div>
            <div clas="level" id="knowledge-qrcode" style="display:none;">
                    <img src="/images/zhishixingqiu.png"/>
            </div>
        </div>
        
        
        <div class="level is-mobile">
            
            <a class="level-item button is-white is-marginless" target="_blank"
                title="Github" href="https://github.com/qingyeinfo">
                
                <i class="fab fa-github"></i>
                
            </a>
            
            <a class="level-item button is-white is-marginless" target="_blank"
                title="Email" href="http://mail.qq.com/cgi-bin/qm_share?t=qm_mailme&amp;email=qingyeinfo@gmail.com">
                
                <i class="fa fa-envelope"></i>
                
            </a>
            
            <a class="level-item button is-white is-marginless" target="_blank"
                title="RSS" href="/atom.xml">
                
                <i class="fas fa-rss"></i>
                
            </a>
            
        </div>
        
    </div>
</div>
    
        
    
        
<div class="card widget">
    <div class="card-content">
        <h3 class="menu-label">
            最新文章
        </h3>
        
        <article class="media">
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2020-02-28T14:51:30.000Z">2020-02-28</time></div>
                    <a href="/2020/02/28/glusterfs-two/" class="has-link-black-ter is-size-6">GlusterFS集群文件系统专题二(主要术语)</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/glusterfs/">glusterfs</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2020-02-25T15:20:56.000Z">2020-02-25</time></div>
                    <a href="/2020/02/25/glusterfs-one/" class="has-link-black-ter is-size-6">GlusterFS集群文件系统专题一(基础原理)</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/glusterfs/">glusterfs</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2020-02-23T15:36:41.000Z">2020-02-23</time></div>
                    <a href="/2020/02/23/ntp-server/" class="has-link-black-ter is-size-6">ntp-server服务端部署和配置</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/ntp/">ntp</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2020-01-14T15:15:45.000Z">2020-01-14</time></div>
                    <a href="/2020/01/14/yum-source/" class="has-link-black-ter is-size-6">YUM源部署和使用</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/yum/">yum</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2020-01-14T14:37:30.000Z">2020-01-14</time></div>
                    <a href="/2020/01/14/rkhunter/" class="has-link-black-ter is-size-6">rkhunter安装和使用</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/rkhunter/">rkhunter</a>
                    </p>
                </div>
            </div>
        </article>
        
    </div>
</div>

    
        <div class="card widget">
    <div class="card-content">
        <div class="menu">
        <h3 class="menu-label">
            归档
        </h3>
        <ul class="menu-list">
        
        <li>
            <a class="level is-marginless" href="/archives/2020/02/">
                <span class="level-start">
                    <span class="level-item">二月 2020</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2020/01/">
                <span class="level-start">
                    <span class="level-item">一月 2020</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/11/">
                <span class="level-start">
                    <span class="level-item">十一月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        </ul>
        </div>
    </div>
</div>
    
        
<div class="card widget">
    <div class="card-content">
        <div class="menu">
            <h3 class="menu-label">
                分类
            </h3>
            <ul class="menu-list">
            <li>
        <a class="level is-marginless" href="/categories/Tengine/">
            <span class="level-start">
                <span class="level-item">Tengine</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">2</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/glusterfs/">
            <span class="level-start">
                <span class="level-item">glusterfs</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">2</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/ntp/">
            <span class="level-start">
                <span class="level-item">ntp</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/rkhunter/">
            <span class="level-start">
                <span class="level-item">rkhunter</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/yum/">
            <span class="level-start">
                <span class="level-item">yum</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li>
            </ul>
        </div>
    </div>
</div>
    
        
<div class="card widget">
    <div class="card-content">
        <h3 class="menu-label">
            标签云
        </h3>
        <a href="/tags/centos/" style="font-size: 16.67px;">centos</a> <a href="/tags/glusterfs/" style="font-size: 13.33px;">glusterfs</a> <a href="/tags/http2/" style="font-size: 10px;">http2</a> <a href="/tags/https/" style="font-size: 10px;">https</a> <a href="/tags/linux/" style="font-size: 20px;">linux</a> <a href="/tags/nginx/" style="font-size: 13.33px;">nginx</a> <a href="/tags/ntp/" style="font-size: 10px;">ntp</a> <a href="/tags/openssl/" style="font-size: 10px;">openssl</a> <a href="/tags/shell/" style="font-size: 10px;">shell</a> <a href="/tags/tengine/" style="font-size: 13.33px;">tengine</a> <a href="/tags/yum%E6%BA%90/" style="font-size: 10px;">yum源</a>
    </div>
</div>

    
        <div class="card widget">
    <div class="card-content">
        <div class="menu">
            <h3 class="menu-label">
                标签
            </h3>
            <div class="field is-grouped is-grouped-multiline">
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/centos/">
                        <span class="tag">centos</span>
                        <span class="tag is-grey">4</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/glusterfs/">
                        <span class="tag">glusterfs</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/http2/">
                        <span class="tag">http2</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/https/">
                        <span class="tag">https</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/linux/">
                        <span class="tag">linux</span>
                        <span class="tag is-grey">7</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/nginx/">
                        <span class="tag">nginx</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/ntp/">
                        <span class="tag">ntp</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/openssl/">
                        <span class="tag">openssl</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/shell/">
                        <span class="tag">shell</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/tengine/">
                        <span class="tag">tengine</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/yum%E6%BA%90/">
                        <span class="tag">yum源</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
            </div>
        </div>
    </div>
</div>
    
    
        <div class="column-right-shadow  is-sticky">
        
        </div>
    
</div>

                
            </div>
        </div>
    </section>
    <footer class="footer">
    <div class="container">
        <div class="level">
            <div class="level-start has-text-centered-mobile">
                <a class="footer-logo is-block has-mb-6" href="/">
                
                    <img src="/images/logo.svg" alt="Tengine 基础原理和基本使用" height="28">
                
                </a>
                <p class="is-size-7">
                &copy; 2020 青叶&nbsp;
                <a href="http://www.beian.miit.gov.cn" target="_blank">粤ICP备19143656号-1</a>
                Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> & <a
                        href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank">Icarus</a>
                        <br>
                        <span><i class="fa fa-bug" aria-hidden="true"></i> Websit Spider <a href="http://qingye.info/baidusitemap.xml">Baidu Sitmap</a>  and  <a href="http://qingye.info/sitemap.xml">Google Sitmap</a></span>
                
                <br>
                <span id="busuanzi_container_site_uv">
                共<span id="busuanzi_value_site_uv">0</span>个访客
                </span>
                
                
                
                
                
                
                
                
                
                
                </p>
            </div>
            <div class="level-end">
            
                <div class="field has-addons is-flex-center-mobile has-mt-5-mobile is-flex-wrap is-flex-middle">
                
                
                <p class="control">
                    <a class="button is-white is-large" target="_blank" title="Creative Commons" href="https://creativecommons.org/">
                        
                        <i class="fab fa-creative-commons"></i>
                        
                    </a>
                </p>
                
                <p class="control">
                    <a class="button is-white is-large" target="_blank" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/">
                        
                        <i class="fab fa-creative-commons-by"></i>
                        
                    </a>
                </p>
                
                <p class="control">
                    <a class="button is-white is-large" target="_blank" title="Download on GitHub" href="https://github.com/qingyeinfo">
                        
                        <i class="fab fa-github"></i>
                        
                    </a>
                </p>
                
                </div>
            
            </div>
        </div>
    </div>
</footer>
    <script src="https://libs.baidu.com/jquery/1.11.1/jquery.min.js"></script>
<script src="https://unpkg.com/moment@2.22.2/min/moment-with-locales.min.js"></script>
<script>moment.locale("zh-CN");</script>


    
    
    
    <script src="/js/animation.js"></script>
    

    
    
    
    <script src="https://unpkg.com/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script>
    <script src="https://unpkg.com/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script>
    <script src="/js/gallery.js" defer></script>
    

    
    

<div id="outdated">
    <h6>Your browser is out-of-date!</h6>
    <p>Update your browser to view this website correctly. <a id="btnUpdateBrowser" href="http://outdatedbrowser.com/" target="_blank" rel="noopener">Update
            my browser now </a></p>
    <p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">&times;</a></p>
</div>
<script src="https://unpkg.com/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.js" defer></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        outdatedBrowser({
            bgColor: '#f25648',
            color: '#ffffff',
            lowerThan: 'flex'
        });
    });
</script>


    
    
    
    

<a id="back-to-top" title="回到顶端" href="javascript:;" target="_blank" rel="noopener">
    <i class="fas fa-chevron-up"></i>
</a>
<script src="/js/back-to-top.js" defer></script>


    
    

    
    
    
    

    
    
    
    
    
    <script src="https://unpkg.com/clipboard@2.0.4/dist/clipboard.min.js" defer></script>
    <script src="/js/clipboard.js" defer></script>
    

    
    
    

    
    
    

    
    
    

    
    
    

    


<script src="/js/main.js" defer></script>
<script>
    $(function(){
        var showing = false;
        var headEnter = false;
        var mouseArea =  $("#knowledge-star");
        var qrcode = $("#knowledge-qrcode");
        var headimg = $("#blog-head-img");
        //var originalSrc = headimg.attr("src");

        function knowStarAnim(show){
            if(show === showing) return;
            showing = show;
            qrcode.stop();
            qrcode.toggle(1000);
        }

        mouseArea.mouseenter(function(){
            knowStarAnim(true);  
        });

        mouseArea.mouseleave(function(){
            knowStarAnim(false);
        });

        function headChangeAnim(enter){
            if(enter === headEnter) return;
            headEnter = enter;
            if(enter){
                $("img").attr("title", function() { return this.src });
                $("img").attr("src", function(){
                    if(this.width < 150){
                        return "http://localhost:4000/images/avatar.png";
                    }else{
                        return this.src;
                    }
                })
            }else{
                $("img").attr("src", function() { return this.title });
                $("img").removeAttr("title");
            }
        }

        headimg.mouseenter(function(){
            headChangeAnim(true);
        });
        headimg.mouseleave(function(){
            headChangeAnim(false);
        });
    });
</script>

    
    <div class="searchbox ins-search">
    <div class="searchbox-container ins-search-container">
        <div class="searchbox-input-wrapper">
            <input type="text" class="searchbox-input ins-search-input" placeholder="想要查找什么..." />
            <span class="searchbox-close ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="searchbox-result-wrapper ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
    (function (window) {
        var INSIGHT_CONFIG = {
            TRANSLATION: {
                POSTS: '文章',
                PAGES: '页面',
                CATEGORIES: '分类',
                TAGS: '标签',
                UNTITLED: '(无标题)',
            },
            CONTENT_URL: '/content.json',
        };
        window.INSIGHT_CONFIG = INSIGHT_CONFIG;
    })(window);
</script>
<script src="/js/insight.js" defer></script>
<link rel="stylesheet" href="/css/search.css">
<link rel="stylesheet" href="/css/insight.css">
    
<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/miku.model.json"},"display":{"position":"right","width":300,"height":600},"mobile":{"show":true},"react":{"opacity":0.7},"log":false});</script></body>
</html>